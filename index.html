<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand Studio CREATE - Professional Briefing Analysis v4</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-900: #0f172a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-900);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2rem 0;
            text-align: center;
        }

        .brand {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .brand-icon {
            font-size: 2.5rem;
            color: #fbbf24;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .brand h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .tagline {
            font-size: 1.125rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 300;
        }

        .main {
            padding: 3rem 0;
        }

        .upload-card {
            max-width: 600px;
            margin: 0 auto 3rem;
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }

        .upload-area {
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px dashed var(--gray-200);
            border-radius: 1.5rem;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: var(--gray-50);
            transform: translateY(-2px);
        }

        .upload-area.dragging {
            border-color: var(--primary);
            background: #eff6ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
        }

        .upload-content h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.75rem;
        }

        .upload-content p {
            color: var(--gray-600);
            margin-bottom: 1.5rem;
            font-size: 1.125rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
        }

        .processing-section {
            display: none;
            justify-content: center;
            margin: 3rem 0;
        }

        .processing-card {
            background: white;
            border-radius: 1.5rem;
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            max-width: 500px;
            width: 100%;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--gray-200);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            display: none;
        }

        .decision-banner {
            background: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            border-left: 8px solid var(--success);
        }

        .decision-banner.needs-more-info {
            border-left-color: var(--warning);
        }

        .decision-banner.rejected {
            border-left-color: var(--error);
        }

        .decision-content {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .decision-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .decision-icon.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .decision-icon.error {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
        }

        .decision-info h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .decision-info p {
            font-size: 1.125rem;
            color: var(--gray-600);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .data-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }

        .data-header {
            background: var(--gray-50);
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .data-header i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .data-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .data-content {
            padding: 1.5rem;
        }

        .data-field {
            margin-bottom: 1.5rem;
        }

        .data-field:last-child {
            margin-bottom: 0;
        }

        .data-field label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-field span {
            display: block;
            font-size: 1rem;
            font-weight: 500;
            color: var(--gray-900);
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--gray-200);
            min-height: 3rem;
            display: flex;
            align-items: center;
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 2px solid var(--gray-200);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .brand {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .brand h1 {
                font-size: 2rem;
            }
            
            .decision-content {
                flex-direction: column;
                text-align: center;
            }
            
            .data-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="container">
                <div class="brand">
                    <i class="fas fa-bolt brand-icon"></i>
                    <h1>Brand Studio CREATE</h1>
                </div>
                <p class="tagline">Professional Briefing Analysis & GO/NO-GO Decision Engine v4</p>
            </div>
        </header>

        <main class="main">
            <div class="container">
                <!-- Upload Section -->
                <section class="upload-section" id="uploadSection">
                    <div class="upload-card">
                        <div class="upload-area" id="uploadArea">
                            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                            <div class="upload-content">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h2>Upload Your Briefing</h2>
                                <p>Drag and drop your PDF briefing here</p>
                                <div style="margin-top: 1.5rem; color: var(--gray-600); font-size: 0.875rem;">
                                    <small><i class="fas fa-info-circle"></i> Supports PDF files up to 10MB</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Processing Section -->
                <section class="processing-section" id="processingSection">
                    <div class="processing-card">
                        <div class="spinner"></div>
                        <h2>Analyzing Briefing</h2>
                        <p>Extracting data following CLAUDE.md v4 specifications...</p>
                        <div style="margin-top: 1rem; color: var(--primary); font-weight: 500;" id="processingStatus">
                            Reading PDF file...
                        </div>
                    </div>
                </section>

                <!-- Results Section -->
                <section class="results-section" id="resultsSection">
                    <div class="decision-banner" id="decisionBanner">
                        <div class="decision-content">
                            <div class="decision-icon" id="decisionIcon">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="decision-info">
                                <h2 id="decisionTitle">Processing Complete</h2>
                                <p id="decisionMessage">Your PDF has been successfully analyzed.</p>
                            </div>
                            <div style="display: flex; gap: 1rem; align-items: center; margin-left: auto;">
                                <button class="btn-secondary" onclick="exportData()">
                                    <i class="fas fa-download"></i>
                                    Export JSON
                                </button>
                                <button class="btn-secondary" onclick="reset()">
                                    <i class="fas fa-upload"></i>
                                    New Briefing
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Extracted Data Grid -->
                    <div class="data-grid" id="dataGrid">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // Configure PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        
        console.log('üöÄ Brand Studio CREATE v4 Loading...');
        
        // Global variables
        let currentData = null;
        
        // DOM elements
        const elements = {
            uploadSection: document.getElementById('uploadSection'),
            processingSection: document.getElementById('processingSection'),
            resultsSection: document.getElementById('resultsSection'),
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            uploadBtn: document.getElementById('uploadBtn'),
            processingStatus: document.getElementById('processingStatus'),
            decisionBanner: document.getElementById('decisionBanner'),
            decisionIcon: document.getElementById('decisionIcon'),
            decisionTitle: document.getElementById('decisionTitle'),
            decisionMessage: document.getElementById('decisionMessage'),
            dataGrid: document.getElementById('dataGrid')
        };
        
        // Event listeners
        elements.uploadArea.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('üì¶ Upload area clicked');
            elements.fileInput.click();
        });
        
        elements.fileInput.addEventListener('change', (e) => {
            console.log('üìÅ File selected');
            handleFile(e.target.files[0]);
        });
        
        // Drag and drop
        elements.uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.add('dragging');
        });
        
        elements.uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            if (!elements.uploadArea.contains(e.relatedTarget)) {
                elements.uploadArea.classList.remove('dragging');
            }
        });
        
        elements.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.remove('dragging');
            console.log('üì• File dropped');
            handleFile(e.dataTransfer.files[0]);
        });
        
        // Prevent default drag behaviors on document
        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', e => e.preventDefault());
        
        async function handleFile(file) {
            if (!file) {
                alert('No file selected');
                return;
            }
            
            if (file.type !== 'application/pdf') {
                alert('Please select a PDF file only');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB
                alert('File too large. Please select a PDF under 10MB');
                return;
            }
            
            console.log('üìä Processing file:', file.name, (file.size / 1024).toFixed(1), 'KB');
            
            // Show processing state
            showProcessing();
            
            try {
                // Update status
                updateStatus('Reading PDF file...');
                await delay(500);
                
                // Extract text
                const text = await extractPDFText(file);
                console.log('‚úÖ Text extracted:', text.length, 'characters');
                
                updateStatus('Analyzing content according to CLAUDE.md v4...');
                await delay(800);
                
                // Extract comprehensive data following CLAUDE.md v4
                const briefingData = extractBriefingDataV4(text, file.name);
                console.log('üìä Data extracted:', briefingData);
                
                updateStatus('Evaluating CREATE criteria & making decision...');
                await delay(600);
                
                // Evaluate with enhanced logic
                const evaluation = evaluateCreateCriteriaV4(briefingData);
                console.log('üéØ Evaluation complete:', evaluation);
                
                // Store and show results
                currentData = { briefing: briefingData, evaluation, originalText: text };
                showResults();
                
            } catch (error) {
                console.error('‚ùå Error processing PDF:', error);
                alert('Failed to process PDF: ' + error.message);
                reset();
            }
        }
        
        async function extractPDFText(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                console.log('üìö Array buffer created:', arrayBuffer.byteLength, 'bytes');
                
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                console.log('üìñ PDF loaded, pages:', pdf.numPages);
                
                let fullText = '';
                
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    
                    const pageText = textContent.items
                        .filter(item => item.str && item.str.trim())
                        .map(item => item.str)
                        .join(' ');
                    
                    if (pageText.trim()) {
                        fullText += pageText + '\n\n';
                    }
                    
                    console.log(`üìÑ Page ${pageNum} processed:`, pageText.length, 'characters');
                }
                
                if (!fullText.trim()) {
                    throw new Error('No readable text found in PDF');
                }
                
                return fullText.trim();
                
            } catch (error) {
                console.error('üí• PDF extraction failed:', error);
                throw new Error('Could not read PDF file. Please ensure it contains readable text.');
            }
        }
        
        function extractBriefingDataV4(text, fileName) {
            console.log('üìÑ FULL PDF TEXT (first 1000 chars):', text.substring(0, 1000));
            console.log('üìÑ PDF TEXT LENGTH:', text.length);
            
            const today = new Date().toISOString().split('T')[0];
            
            // Enhanced extraction following CLAUDE.md v4 specifications
            return {
                meta: {
                    source_file: fileName,
                    extraction_ts: today
                },
                contact: {
                    responsable_commercial: extractPattern(text, [
                        /responsable\s+commercial[\s\w]*:?\s*([A-Za-z\s]+)/i,
                        /karolien\s+van\s+gaever/i,
                        /contact[\s\w]*:?\s*([A-Za-z\s]+)/i
                    ]),
                    agence_media: extractPattern(text, [
                        /agence\s+media[\s\w]*:?\s*([A-Za-z\s&-]+)/i,
                        /group\s*m\s*[-‚Äì]?\s*essence\s*mediacom/i,
                        /essence\s+mediacom/i
                    ])
                },
                advertiser: {
                    group_or_annonceur: extractAdvertiserAggressive(text),
                    brand_or_product: extractProductAggressive(text)
                },
                brief: {
                    type: extractPattern(text, [
                        /type[\s\w]*brief[\s]*:?\s*([A-Za-z\s-]+)/i,
                        /typologie[\s\w]*campagne[\s]*:?\s*([A-Za-z\s-]+)/i
                    ]),
                    urgency: extractUrgency(text),
                    typologie_annonceur: extractPattern(text, [
                        /typologie[\s\w]*annonceur[\s]*:?\s*([A-Za-z\s-]+)/i
                    ]),
                    presentation_languages: extractLanguages(text),
                    attachments_present: detectAttachments(text),
                    target_persona: extractPattern(text, [
                        /cible[\s\w]*:?\s*([A-Za-z0-9\s-‚Äì]+)/i,
                        /persona[\s\w]*:?\s*([A-Za-z0-9\s-‚Äì]+)/i,
                        /18[-\s]*54[\s]*[-‚Äì]?[\s]*sportifs/i,
                        /studenten/i
                    ]),
                    objectives: extractObjectives(text),
                    start_momentum_reason: extractPattern(text, [
                        /momentum[\s\w]*:?\s*([A-Za-z0-9\s,.'!-‚Äì]+)/i,
                        /start[\s\w]*campagne[\s]*:?\s*([A-Za-z\s-‚Äì]+)/i,
                        /raison[\s\w]*:?\s*([A-Za-z\s-‚Äì]+)/i
                    ]),
                    end_date: extractDate(text, /end|fin|termine/i),
                    key_messages: extractPattern(text, [
                        /message[\s\w]*cl[e√©]s?[\s]*:?\s*([A-Za-z\s,.'!-‚Äì]+)/i,
                        /choississez\s*powerade/i,
                        /back\s*to\s*school/i
                    ]),
                    media_specific_preferences: extractMediaPreferences(text),
                    history_with_rossel: extractPattern(text, [
                        /historique[\s\w]*rossel[\s]*:?\s*([A-Za-z\s,.'!-‚Äì]+)/i
                    ]),
                    other_campaigns_with_rossel: extractPattern(text, [
                        /campagne[\s\w]*cours[\s]*:?\s*([A-Za-z\s,.'!-‚Äì]+)/i,
                        /campagne[\s\w]*venir[\s]*:?\s*([A-Za-z\s,.'!-‚Äì]+)/i
                    ]),
                    notes: extractNotes(text)
                },
                constraints: {
                    min_budget_create_eur: 10000, // CLAUDE.md v4 constant
                    budget_confirmed_eur_range: extractBudgetRange(text),
                    proposal_deadline: extractDate(text, /date\s+limite|deadline|remise/i),
                    lead_time_business_days_after_valid_brief: 10, // CLAUDE.md v4 constant
                    do_not: extractDoNotList(text),
                    prefer: extractPreferList(text)
                },
                creative: {
                    sports_focus: extractSportsFocus(text),
                    audience_activity_min_sessions_per_week: extractActivityFrequency(text)
                },
                internal: {
                    briefing_acceptance_status: 'needs_more_info', // Will be determined by evaluation
                    acceptance_reason: null,
                    action_recommend_publishers: false,
                    internal_publisher_recommendation: null,
                    internal_notes: null
                },
                supplemental: {
                    other_fields: null,
                    source_field_map: null
                }
            };
        }
        
        function extractAdvertiserAggressive(text) {
            console.log('üöÄ EXTRACTING ADVERTISER - Starting aggressive search...');
            
            // Method 1: Try specific brand patterns first
            const knownBrands = [
                'coca-cola', 'coca cola', 'cocacola', 'coca',
                'oneplus', 'one plus',
                'unilever', 'nestl√©', 'nestle', 'pepsi', 'microsoft', 'apple', 'samsung',
                'nike', 'adidas', 'google', 'amazon', 'facebook', 'meta'
            ];
            
            for (const brand of knownBrands) {
                const regex = new RegExp(brand, 'gi');
                const matches = text.match(regex);
                if (matches && matches.length > 0) {
                    const result = matches[0];
                    console.log(`üéØ ADVERTISER FOUND (known brand):`, result);
                    return result.charAt(0).toUpperCase() + result.slice(1).toLowerCase();
                }
            }
            
            // Method 2: Look for formal field patterns
            const fieldPatterns = [
                /groupe[\s\w]*annonceur[\s\w]*:?\s*([A-Za-z\s-]+)/i,
                /annonceur[\s\w]*:?\s*([A-Za-z\s-]+)/i,
                /groupe[\s]*:?\s*([A-Za-z\s-]+)/i,
                /client[\s\w]*:?\s*([A-Za-z\s-]+)/i,
                /advertiser[\s\w]*:?\s*([A-Za-z\s-]+)/i
            ];
            
            for (const pattern of fieldPatterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].trim().length > 2) {
                    const result = match[1].trim();
                    console.log(`üéØ ADVERTISER FOUND (field pattern):`, result);
                    return result;
                }
            }
            
            // Method 3: Look for capitalized words that might be company names
            const capitalizedWords = text.match(/\b[A-Z][a-z]{2,}\b/g);
            if (capitalizedWords) {
                // Filter out common words
                const commonWords = ['The', 'And', 'For', 'With', 'This', 'That', 'Create', 'Brief', 'Campaign', 'Media', 'Digital', 'Marketing', 'Agency', 'Studio', 'Brand'];
                const candidates = capitalizedWords.filter(word => 
                    !commonWords.includes(word) && 
                    word.length > 3 &&
                    !/^\d/.test(word)
                );
                
                if (candidates.length > 0) {
                    const result = candidates[0];
                    console.log(`üéØ ADVERTISER FOUND (capitalized word):`, result, 'from candidates:', candidates.slice(0, 5));
                    return result;
                }
            }
            
            console.log('‚ùå ADVERTISER NOT FOUND - No patterns matched');
            return null;
        }
        
        function extractProductAggressive(text) {
            console.log('üöÄ EXTRACTING PRODUCT - Starting aggressive search...');
            
            // Method 1: Try specific product patterns first
            const knownProducts = [
                'powerade', 'sprite', 'fanta', 'coca-cola', 'pepsi',
                'nord 5', 'iphone', 'galaxy', 'pixel'
            ];
            
            for (const product of knownProducts) {
                const regex = new RegExp(product, 'gi');
                const matches = text.match(regex);
                if (matches && matches.length > 0) {
                    const result = matches[0];
                    console.log(`üéØ PRODUCT FOUND (known product):`, result);
                    return result.charAt(0).toUpperCase() + result.slice(1).toLowerCase();
                }
            }
            
            // Method 2: Look for formal field patterns
            const fieldPatterns = [
                /marque[\s\w\/]*produit[\s\w]*:?\s*([A-Za-z\s0-9]+)/i,
                /produit[\s\w]*:?\s*([A-Za-z\s0-9]+)/i,
                /marque[\s\w]*:?\s*([A-Za-z\s0-9]+)/i,
                /product[\s\w]*:?\s*([A-Za-z\s0-9]+)/i,
                /brand[\s\w]*:?\s*([A-Za-z\s0-9]+)/i
            ];
            
            for (const pattern of fieldPatterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].trim().length > 2) {
                    const result = match[1].trim();
                    console.log(`üéØ PRODUCT FOUND (field pattern):`, result);
                    return result;
                }
            }
            
            // Method 3: Look for product-like patterns (capitalized words with numbers or special chars)
            const productPatterns = [
                /\b([A-Z][a-z]+\s*\d+)\b/g,  // Like "Nord 5"
                /\b([A-Z][a-z]{4,})\b/g       // Capitalized words 5+ chars
            ];
            
            for (const pattern of productPatterns) {
                const matches = text.match(pattern);
                if (matches && matches.length > 0) {
                    const result = matches[0];
                    console.log(`üéØ PRODUCT FOUND (pattern match):`, result);
                    return result;
                }
            }
            
            console.log('‚ùå PRODUCT NOT FOUND - No patterns matched');
            return null;
        }
        
        function extractPattern(text, patterns, fieldName) {
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    const result = match[1] || match[0];
                    const cleaned = cleanExtractedText(result);
                    if (fieldName === 'group_or_annonceur' || fieldName === 'brand_or_product') {
                        console.log(`üîç ${fieldName} found:`, pattern, '‚Üí', cleaned);
                    }
                    return cleaned;
                }
            }
            if (fieldName === 'group_or_annonceur' || fieldName === 'brand_or_product') {
                console.log(`‚ùå ${fieldName} not found in text preview:`, text.substring(0, 200));
            }
            return null;
        }
        
        function cleanExtractedText(text) {
            return text.trim()
                .replace(/\s+/g, ' ')
                .replace(/^[:\-]\s*/, '')
                .substring(0, 200);
        }
        
        function extractUrgency(text) {
            if (/√©lev√©|urgente?|√©lev√©e/i.test(text)) return 'eleve';
            if (/moyen|moyenne/i.test(text)) return 'moyen';
            if (/faible|basse?/i.test(text)) return 'faible';
            return null;
        }
        
        function extractLanguages(text) {
            const languages = [];
            if (/fran√ßais|french/i.test(text)) languages.push('Fran√ßais');
            if (/n√©erlandais|dutch|nl/i.test(text)) languages.push('N√©erlandais');
            if (/anglais|english/i.test(text)) languages.push('Anglais');
            return languages.length > 0 ? languages : null;
        }
        
        function detectAttachments(text) {
            if (/attachment|pi√®ce\s+jointe|annexe|fichier\s+joint/i.test(text)) return true;
            if (/sans\s+attachement|no\s+attachment/i.test(text)) return false;
            return null;
        }
        
        function extractObjectives(text) {
            const objectives = [];
            if (/awareness|notori√©t√©/i.test(text)) objectives.push('awareness');
            if (/consideration|consid√©ration/i.test(text)) objectives.push('consideration');
            if (/activation|conversion/i.test(text)) objectives.push('activation_conversion');
            return objectives.length > 0 ? objectives : null;
        }
        
        function extractDate(text, contextPattern) {
            const datePatterns = [
                /(\d{1,2})\/(\d{1,2})\/(\d{4})/g,
                /(\d{1,2})[-](\d{1,2})[-](\d{4})/g,
                /(\d{4})-(\d{1,2})-(\d{1,2})/g
            ];
            
            for (const pattern of datePatterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    try {
                        // Handle different date formats
                        let year, month, day;
                        if (match[3] && match[3].length === 4) {
                            // DD/MM/YYYY or DD-MM-YYYY format
                            day = match[1];
                            month = match[2];
                            year = match[3];
                        } else {
                            // YYYY-MM-DD format
                            year = match[1];
                            month = match[2];
                            day = match[3];
                        }
                        return new Date(year, month - 1, day).toISOString().split('T')[0];
                    } catch (e) {
                        continue;
                    }
                }
            }
            return null;
        }
        
        function extractBudgetRange(text) {
            const patterns = [
                /(\d{1,3})[-‚Äì](\d{1,3})\s*k/i,
                /(\d{1,3})\s*k\s*[-‚Äì]\s*(\d{1,3})\s*k/i,
                /‚Ç¨\s*(\d{1,3})[.,](\d{3})\s*[-‚Äì]\s*‚Ç¨\s*(\d{1,3})[.,](\d{3})/i,
                /budget[\s\w]*:?\s*(\d+)\s*[-‚Äì]\s*(\d+)/i
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    let low = parseInt(match[1]);
                    let high = parseInt(match[2]);
                    
                    // Handle K multiplier
                    if (match[0].toLowerCase().includes('k')) {
                        low *= 1000;
                        high *= 1000;
                    }
                    
                    return `${low}-${high}`;
                }
            }
            
            // Single budget amounts
            const singlePattern = /(\d{1,3})\s*k/i;
            const singleMatch = text.match(singlePattern);
            if (singleMatch) {
                const amount = parseInt(singleMatch[1]) * 1000;
                return amount.toString();
            }
            
            return null;
        }
        
        function extractMediaPreferences(text) {
            const preferences = [];
            const mediaRegex = /le\s+soir|sudinfo|kotplanet|rossel|dh|vers\s+l'avenir/gi;
            const matches = text.match(mediaRegex);
            if (matches) {
                preferences.push(...matches.map(m => m.trim()));
            }
            return preferences.length > 0 ? [...new Set(preferences)] : null;
        }
        
        function extractDoNotList(text) {
            const doNotItems = [];
            if (/pas\s+de\s+native|no\s+native/i.test(text)) doNotItems.push('native');
            if (/pas\s+d'influenceurs?|no\s+influencers?/i.test(text)) doNotItems.push('influenceurs');
            if (/√©viter.*programmatic|avoid.*programmatic/i.test(text)) doNotItems.push('programmatic');
            return doNotItems.length > 0 ? doNotItems : null;
        }
        
        function extractPreferList(text) {
            const preferItems = [];
            if (/plut√¥t\s+digital|prefer\s+digital/i.test(text)) preferItems.push('digital');
            if (/privil√©gier.*social|prefer.*social/i.test(text)) preferItems.push('social');
            if (/focus.*search|privil√©gier.*search/i.test(text)) preferItems.push('search');
            return preferItems.length > 0 ? preferItems : null;
        }
        
        function extractSportsFocus(text) {
            const sports = [];
            const sportsList = ['padel', 'hockey', 'basket', 'running', 'football', 'tennis', 'rugby', 'cycling', 'swimming'];
            
            for (const sport of sportsList) {
                if (new RegExp(sport, 'i').test(text)) {
                    sports.push(sport);
                }
            }
            return sports.length > 0 ? sports : null;
        }
        
        function extractActivityFrequency(text) {
            const patterns = [
                /(\d+)\s*x?\s*[/]?\s*semaine/i,
                /min\s*(\d+)\s*fois?/i,
                /‚â•\s*(\d+)\s*x/i
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    return parseInt(match[1]);
                }
            }
            return null;
        }
        
        function extractNotes(text) {
            const notePatterns = [
                /compl√©ments?[\s\w]*:?\s*([^\n.]{50,400})/i,
                /notes?[\s\w]*:?\s*([^\n.]{50,400})/i,
                /remarques?[\s\w]*:?\s*([^\n.]{50,400})/i,
                /int√©r√™t\s*pour\s*([^\n.]{20,300})/i
            ];
            
            for (const pattern of notePatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    return cleanExtractedText(match[1]);
                }
            }
            return null;
        }
        
        function evaluateCreateCriteriaV4(data) {
            const evaluation = {
                overall_decision: 'needs_more_info',
                acceptance_reason: null,
                action_recommend_publishers: false,
                internal_publisher_recommendation: null,
                internal_notes: null,
                score: 0,
                max_score: 100,
                criteria: {
                    budget: { status: 'FAIL', score: 0, message: '' },
                    timeline: { status: 'FAIL', score: 0, message: '' },
                    required_fields: { status: 'FAIL', score: 0, message: '' }
                },
                issues: [],
                recommendations: []
            };
            
            // Budget evaluation (40 points)
            if (data.constraints.budget_confirmed_eur_range) {
                const budgetStr = data.constraints.budget_confirmed_eur_range;
                const minBudget = budgetStr.includes('-') ? 
                    parseInt(budgetStr.split('-')[0]) : 
                    parseInt(budgetStr);
                const requiredBudget = data.constraints.min_budget_create_eur;
                
                if (minBudget >= requiredBudget) {
                    evaluation.criteria.budget = {
                        status: 'PASS',
                        score: 40,
                        message: `Budget confirmed: ‚Ç¨${minBudget.toLocaleString()} ‚â• ‚Ç¨${requiredBudget.toLocaleString()}`
                    };
                } else {
                    evaluation.criteria.budget = {
                        status: 'FAIL',
                        score: 0,
                        message: `Budget insufficient: ‚Ç¨${minBudget.toLocaleString()} < ‚Ç¨${requiredBudget.toLocaleString()}`
                    };
                    evaluation.issues.push('Budget below CREATE minimum');
                }
            } else {
                evaluation.criteria.budget = {
                    status: 'FAIL',
                    score: 0,
                    message: 'Budget not confirmed'
                };
                evaluation.issues.push('No confirmed budget found');
            }
            
            // Timeline evaluation (30 points)
            if (data.constraints.proposal_deadline) {
                const deadline = new Date(data.constraints.proposal_deadline);
                const today = new Date();
                const daysAvailable = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                const requiredDays = data.constraints.lead_time_business_days_after_valid_brief;
                
                if (daysAvailable >= requiredDays) {
                    evaluation.criteria.timeline = {
                        status: 'PASS',
                        score: 30,
                        message: `Timeline adequate: ${daysAvailable} days ‚â• ${requiredDays} days`
                    };
                } else {
                    evaluation.criteria.timeline = {
                        status: 'FAIL',
                        score: 0,
                        message: `Timeline insufficient: ${daysAvailable} days < ${requiredDays} days`
                    };
                    evaluation.issues.push('Insufficient lead time');
                }
            } else {
                evaluation.criteria.timeline = {
                    status: 'FAIL',
                    score: 0,
                    message: 'No deadline specified'
                };
                evaluation.issues.push('Missing deadline');
            }
            
            // Required fields (30 points)
            const requiredFields = ['responsable_commercial', 'group_or_annonceur', 'target_persona'];
            const missingFields = [];
            
            if (!data.contact.responsable_commercial) missingFields.push('responsable commercial');
            if (!data.advertiser.group_or_annonceur) missingFields.push('group annonceur');
            if (!data.brief.target_persona) missingFields.push('target persona');
            
            if (missingFields.length === 0) {
                evaluation.criteria.required_fields = {
                    status: 'PASS',
                    score: 30,
                    message: 'All required fields present'
                };
            } else {
                evaluation.criteria.required_fields = {
                    status: 'FAIL',
                    score: Math.max(0, 30 - (missingFields.length * 10)),
                    message: `Missing: ${missingFields.join(', ')}`
                };
                evaluation.issues.push(`Missing: ${missingFields.join(', ')}`);
            }
            
            // Calculate overall score
            evaluation.score = Object.values(evaluation.criteria)
                .reduce((total, criterion) => total + criterion.score, 0);
            
            // Final decision based on CLAUDE.md v4 logic
            const allCriticalPassed = evaluation.criteria.budget.status === 'PASS' && 
                                     evaluation.criteria.timeline.status === 'PASS';
            
            if (allCriticalPassed && evaluation.score >= 80) {
                evaluation.overall_decision = 'accepted';
                evaluation.acceptance_reason = 'All CREATE criteria met';
                evaluation.action_recommend_publishers = true;
                evaluation.internal_publisher_recommendation = getPublisherRecommendations(data);
            } else if (allCriticalPassed && evaluation.score >= 60) {
                evaluation.overall_decision = 'needs_more_info';
                evaluation.recommendations.push('Review missing information');
            } else {
                evaluation.overall_decision = 'rejected';
            }
            
            evaluation.internal_notes = generateInternalNotes(data, evaluation);
            
            // Update the data object's internal section according to CLAUDE.md v4
            data.internal.briefing_acceptance_status = evaluation.overall_decision;
            data.internal.acceptance_reason = evaluation.acceptance_reason;
            data.internal.action_recommend_publishers = evaluation.action_recommend_publishers;
            data.internal.internal_publisher_recommendation = evaluation.internal_publisher_recommendation;
            data.internal.internal_notes = evaluation.internal_notes;
            
            return evaluation;
        }
        
        function getPublisherRecommendations(data) {
            const recommendations = [];
            
            if (data.constraints.prefer?.includes('digital')) {
                recommendations.push('DH Les Sports+', 'Rossel Digital Network');
            }
            
            if (data.creative?.sports_focus?.length > 0) {
                recommendations.push('Le Soir Sports', 'Sudinfo Sports');
            }
            
            if (data.brief.target_persona?.includes('18-') || data.brief.target_persona?.includes('25-')) {
                recommendations.push('Kotplanet', 'Rossel Student Network');
            }
            
            if (data.constraints.do_not?.includes('native')) {
                recommendations.push('Direct Digital Placements');
            }
            
            return recommendations.length > 0 ? [...new Set(recommendations)] : null;
        }
        
        function generateInternalNotes(data, evaluation) {
            const notes = [];
            
            if (data.constraints.do_not?.length > 0) {
                notes.push(`Avoid: ${data.constraints.do_not.join(', ')}`);
            }
            
            if (data.constraints.prefer?.length > 0) {
                notes.push(`Prefer: ${data.constraints.prefer.join(', ')}`);
            }
            
            if (data.creative?.sports_focus?.length > 0) {
                notes.push(`Sports focus: ${data.creative.sports_focus.join(', ')}`);
            }
            
            if (evaluation.issues?.length > 0) {
                notes.push(`Issues: ${evaluation.issues.join(', ')}`);
            }
            
            if (evaluation.overall_decision === 'accepted') {
                notes.push('Prepare internal publisher short-list for immediate execution');
            }
            
            return notes.length > 0 ? notes.join('. ') : null;
        }
        
        function showProcessing() {
            elements.uploadSection.style.display = 'none';
            elements.processingSection.style.display = 'flex';
            elements.resultsSection.style.display = 'none';
        }
        
        function updateStatus(message) {
            elements.processingStatus.textContent = message;
            console.log('üìç', message);
        }
        
        function showResults() {
            elements.uploadSection.style.display = 'none';
            elements.processingSection.style.display = 'none';
            elements.resultsSection.style.display = 'block';
            
            updateDecisionBanner();
            populateDataGrid();
        }
        
        function updateDecisionBanner() {
            const { evaluation } = currentData;
            
            // Reset classes
            elements.decisionBanner.className = 'decision-banner';
            elements.decisionIcon.className = 'decision-icon';
            
            if (evaluation.overall_decision === 'accepted') {
                elements.decisionBanner.classList.add('accepted');
                elements.decisionIcon.innerHTML = '<i class="fas fa-check"></i>';
                elements.decisionTitle.textContent = 'ACCEPTED - Brief Approved';
                elements.decisionMessage.textContent = 'All CREATE criteria met. Approved for processing.';
            } else if (evaluation.overall_decision === 'needs_more_info') {
                elements.decisionBanner.classList.add('needs-more-info');
                elements.decisionIcon.classList.add('warning');
                elements.decisionIcon.innerHTML = '<i class="fas fa-exclamation"></i>';
                elements.decisionTitle.textContent = 'NEEDS MORE INFO - Review Required';
                elements.decisionMessage.textContent = 'Core criteria met but additional information needed.';
            } else {
                elements.decisionBanner.classList.add('rejected');
                elements.decisionIcon.classList.add('error');
                elements.decisionIcon.innerHTML = '<i class="fas fa-times"></i>';
                elements.decisionTitle.textContent = 'REJECTED - Brief Declined';
                elements.decisionMessage.textContent = 'CREATE criteria not met. See details below.';
            }
        }
        
        function populateDataGrid() {
            const { briefing, evaluation } = currentData;
            
            const cards = [
                {
                    icon: 'fas fa-file-alt',
                    title: 'Meta Information',
                    fields: [
                        { label: 'Source File', value: briefing.meta.source_file },
                        { label: 'Extraction Date', value: briefing.meta.extraction_ts },
                        { label: 'Overall Decision', value: evaluation.overall_decision.toUpperCase() },
                        { label: 'Score', value: `${evaluation.score}/${evaluation.max_score}` }
                    ]
                },
                {
                    icon: 'fas fa-address-book',
                    title: 'Contact Information',
                    fields: [
                        { label: 'Responsable Commercial', value: briefing.contact.responsable_commercial },
                        { label: 'Agence Media', value: briefing.contact.agence_media }
                    ]
                },
                {
                    icon: 'fas fa-building',
                    title: 'Advertiser',
                    fields: [
                        { label: 'Group/Annonceur', value: briefing.advertiser.group_or_annonceur },
                        { label: 'Brand/Product', value: briefing.advertiser.brand_or_product }
                    ]
                },
                {
                    icon: 'fas fa-clipboard-list',
                    title: 'Brief Details',
                    fields: [
                        { label: 'Type', value: briefing.brief.type },
                        { label: 'Urgency', value: briefing.brief.urgency },
                        { label: 'Typologie Annonceur', value: briefing.brief.typologie_annonceur },
                        { label: 'Target Persona', value: briefing.brief.target_persona },
                        { label: 'Key Messages', value: briefing.brief.key_messages },
                        { label: 'Notes', value: briefing.brief.notes }
                    ]
                },
                {
                    icon: 'fas fa-euro-sign',
                    title: 'Constraints',
                    fields: [
                        { label: 'Min Budget CREATE', value: `‚Ç¨${briefing.constraints.min_budget_create_eur.toLocaleString()}` },
                        { label: 'Budget Confirmed Range', value: formatBudgetRange(briefing.constraints.budget_confirmed_eur_range) },
                        { label: 'Proposal Deadline', value: briefing.constraints.proposal_deadline },
                        { label: 'Lead Time Required', value: `${briefing.constraints.lead_time_business_days_after_valid_brief} business days` },
                        { label: 'Do Not', value: Array.isArray(briefing.constraints.do_not) ? briefing.constraints.do_not.join(', ') : briefing.constraints.do_not },
                        { label: 'Prefer', value: Array.isArray(briefing.constraints.prefer) ? briefing.constraints.prefer.join(', ') : briefing.constraints.prefer }
                    ]
                },
                {
                    icon: 'fas fa-paint-brush',
                    title: 'Creative & Sports',
                    fields: [
                        { label: 'Sports Focus', value: Array.isArray(briefing.creative.sports_focus) ? briefing.creative.sports_focus.join(', ') : briefing.creative.sports_focus },
                        { label: 'Activity Min/Week', value: briefing.creative.audience_activity_min_sessions_per_week ? `${briefing.creative.audience_activity_min_sessions_per_week} sessions` : null }
                    ]
                },
                {
                    icon: 'fas fa-cogs',
                    title: 'Internal Analysis',
                    fields: [
                        { label: 'Acceptance Status', value: evaluation.overall_decision },
                        { label: 'Action Recommend', value: evaluation.action_recommend_publishers ? 'Yes' : 'No' },
                        { label: 'Publisher Recommendations', value: Array.isArray(evaluation.internal_publisher_recommendation) ? evaluation.internal_publisher_recommendation.join(', ') : evaluation.internal_publisher_recommendation },
                        { label: 'Internal Notes', value: evaluation.internal_notes }
                    ]
                }
            ];
            
            elements.dataGrid.innerHTML = cards.map(card => `
                <div class="data-card">
                    <div class="data-header">
                        <i class="${card.icon}"></i>
                        <h3>${card.title}</h3>
                    </div>
                    <div class="data-content">
                        ${card.fields.map(field => `
                            <div class="data-field">
                                <label>${field.label}</label>
                                <span>${field.value || '-'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function formatBudgetRange(range) {
            if (!range) return null;
            
            if (range.includes('-')) {
                const [low, high] = range.split('-');
                return `‚Ç¨${parseInt(low).toLocaleString()}-‚Ç¨${parseInt(high).toLocaleString()}`;
            } else {
                return `‚Ç¨${parseInt(range).toLocaleString()}`;
            }
        }
        
        function exportData() {
            if (!currentData) {
                alert('No data to export. Please upload and process a PDF first.');
                return;
            }
            
            try {
                // Create export object following CLAUDE.md v4 schema exactly
                const exportObject = {
                    meta: currentData.briefing.meta,
                    contact: currentData.briefing.contact,
                    advertiser: currentData.briefing.advertiser,
                    brief: currentData.briefing.brief,
                    constraints: currentData.briefing.constraints,
                    creative: currentData.briefing.creative,
                    internal: {
                        briefing_acceptance_status: currentData.evaluation.overall_decision,
                        acceptance_reason: currentData.evaluation.acceptance_reason,
                        action_recommend_publishers: currentData.evaluation.action_recommend_publishers,
                        internal_publisher_recommendation: currentData.evaluation.internal_publisher_recommendation,
                        internal_notes: currentData.evaluation.internal_notes
                    },
                    supplemental: {
                        other_fields: null,
                        source_field_map: null
                    }
                };
                
                // Download as JSON
                const jsonString = JSON.stringify(exportObject, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `briefing-extract-v4-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('üì• Data exported successfully (CLAUDE.md v4 compliant)');
                
            } catch (error) {
                console.error('‚ùå Export failed:', error);
                alert('Failed to export data. Please try again.');
            }
        }
        
        function reset() {
            elements.uploadSection.style.display = 'block';
            elements.processingSection.style.display = 'none';
            elements.resultsSection.style.display = 'none';
            elements.fileInput.value = '';
            elements.uploadArea.classList.remove('dragging');
            currentData = null;
            console.log('üîÑ Reset complete');
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Make functions globally available
        window.exportData = exportData;
        window.reset = reset;
        
        console.log('‚úÖ Brand Studio CREATE v4 Ready! (CLAUDE.md v4 Compliant)');
    </script>
</body>
</html>