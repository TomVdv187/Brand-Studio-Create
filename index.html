<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand Studio CREATE - Professional Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-900: #0f172a;
            --shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-900);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2rem 0;
            text-align: center;
            animation: slideDown 0.8s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .brand {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .brand-icon {
            font-size: 2.5rem;
            color: #fbbf24;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .brand h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .tagline {
            font-size: 1.125rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 300;
        }

        /* Main Content */
        .main {
            padding: 3rem 0;
        }

        /* Upload Section - SMALLER SIZE */
        .upload-card {
            max-width: 500px; /* Reduced from 700px */
            margin: 0 auto 3rem;
            background: white;
            border-radius: 1.5rem;
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: fadeInUp 0.8s ease;
            transition: transform 0.3s ease;
        }

        .upload-card:hover {
            transform: translateY(-5px);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-area {
            padding: 2.5rem 1.5rem; /* Reduced padding */
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px dashed var(--gray-200);
            border-radius: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.1), transparent);
            transition: left 0.6s;
        }

        .upload-area:hover::before {
            left: 100%;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: var(--gray-50);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
        }

        .upload-area.dragging {
            border-color: var(--primary);
            background: #eff6ff;
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(37, 99, 235, 0.3);
        }

        .upload-icon {
            font-size: 3.5rem; /* Reduced from 5rem */
            color: var(--primary);
            margin-bottom: 1.5rem;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .upload-content h2 {
            font-size: 1.75rem; /* Reduced from 2.5rem */
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.75rem;
        }

        .upload-content p {
            color: var(--gray-600);
            margin-bottom: 1.5rem;
            font-size: 1rem; /* Reduced from 1.25rem */
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem; /* Reduced padding */
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            box-shadow: 0 8px 15px -3px rgb(0 0 0 / 0.1);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 25px -5px rgb(0 0 0 / 0.2);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .upload-info {
            margin-top: 1.5rem;
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        /* Processing Section */
        .processing-section {
            display: none;
            justify-content: center;
            margin: 3rem 0;
        }

        .processing-card {
            background: white;
            border-radius: 1.5rem;
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            max-width: 500px;
            width: 100%;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--gray-200);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-card h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        .processing-status {
            color: var(--primary);
            font-weight: 500;
            font-size: 1rem;
            margin-top: 1rem;
            animation: fadeInOut 1.5s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .error-banner {
            background: linear-gradient(135deg, #fee2e2 0%, white 100%);
            border: 1px solid var(--error);
            border-left: 4px solid var(--error);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            display: none;
        }

        .error-banner.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .error-banner h3 {
            color: var(--error);
            font-size: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .error-banner p {
            color: var(--gray-700);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .retry-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
        }

        .retry-btn:hover {
            background: #dc2626;
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: fadeIn 0.6s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Decision Banner */
        .decision-banner {
            background: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: var(--shadow);
            border-left: 8px solid;
            animation: slideInFromLeft 0.8s ease;
        }

        @keyframes slideInFromLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .decision-banner.go {
            border-left-color: var(--success);
            background: linear-gradient(135deg, #d1fae5 0%, white 100%);
        }

        .decision-banner.nogo {
            border-left-color: var(--error);
            background: linear-gradient(135deg, #fee2e2 0%, white 100%);
        }

        .decision-content {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .decision-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2);
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .decision-banner.go .decision-icon {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .decision-banner.nogo .decision-icon {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
        }

        .decision-info {
            flex: 1;
        }

        .decision-info h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .decision-info p {
            font-size: 1.125rem;
            color: var(--gray-600);
            margin-bottom: 1rem;
        }

        .decision-score {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 2px solid var(--gray-200);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
            transform: translateY(-1px);
        }

        /* Evaluation Cards */
        .evaluation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .eval-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            overflow: hidden;
            transition: transform 0.2s ease;
            animation: slideUp 0.6s ease;
        }

        .eval-card:nth-child(1) { animation-delay: 0.1s; }
        .eval-card:nth-child(2) { animation-delay: 0.2s; }
        .eval-card:nth-child(3) { animation-delay: 0.3s; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .eval-card:hover {
            transform: translateY(-4px);
        }

        .eval-header {
            background: var(--gray-50);
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .eval-header i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .eval-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .eval-content {
            padding: 1.5rem;
        }

        .eval-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .eval-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .eval-item label {
            font-weight: 500;
            color: var(--gray-700);
        }

        .eval-item .value {
            font-weight: 600;
            color: var(--gray-900);
        }

        .eval-item .value.highlight {
            color: var(--primary);
        }

        .status {
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .status.valid {
            background: #d1fae5;
            color: var(--success);
        }

        .status.invalid {
            background: #fee2e2;
            color: var(--error);
        }

        .status.missing {
            background: #fef3c7;
            color: var(--warning);
        }

        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .data-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            overflow: hidden;
            animation: fadeInUp 0.8s ease;
        }

        .data-card:nth-child(1) { animation-delay: 0.1s; }
        .data-card:nth-child(2) { animation-delay: 0.2s; }
        .data-card:nth-child(3) { animation-delay: 0.3s; }
        .data-card:nth-child(4) { animation-delay: 0.4s; }

        .data-card.full-width {
            grid-column: 1 / -1;
        }

        .data-header {
            background: var(--gray-50);
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .data-header i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .data-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .data-content {
            padding: 1.5rem;
        }

        .data-content.grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .data-field {
            margin-bottom: 1.5rem;
        }

        .data-field:last-child {
            margin-bottom: 0;
        }

        .data-field label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-field span {
            display: block;
            font-size: 1rem;
            font-weight: 500;
            color: var(--gray-900);
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--gray-200);
            min-height: 3rem;
            display: flex;
            align-items: center;
        }

        .notes-content {
            background: var(--gray-50);
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--gray-200);
            min-height: 4rem;
            line-height: 1.6;
            color: var(--gray-700);
        }

        .text-muted {
            color: var(--gray-600) !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .brand {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .brand h1 {
                font-size: 2rem;
            }
            
            .upload-area {
                padding: 2rem 1rem;
            }
            
            .decision-content {
                flex-direction: column;
                text-align: center;
            }
            
            .evaluation-grid,
            .data-grid {
                grid-template-columns: 1fr;
            }
            
            .data-content.grid-3 {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Animation for form */
        .form-loading {
            pointer-events: none;
            opacity: 0.6;
        }

        .form-loading .upload-area {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="container">
                <div class="brand">
                    <i class="fas fa-bolt brand-icon"></i>
                    <h1>Brand Studio CREATE</h1>
                </div>
                <p class="tagline">Professional Briefing Analysis & GO/NO-GO Decision Engine</p>
            </div>
        </header>

        <main class="main">
            <div class="container">
                <!-- Upload Section -->
                <section class="upload-section" id="uploadSection">
                    <div class="upload-card">
                        <div class="upload-area" id="uploadArea">
                            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                            <div class="upload-content">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h2>Upload Your Briefing</h2>
                                <p>Drag and drop your PDF briefing here, or click to browse</p>
                                <button type="button" class="btn-primary" onclick="document.getElementById('fileInput').click(); console.log('Upload button clicked');">
                                    <i class="fas fa-upload"></i>
                                    Choose PDF File
                                </button>
                                <div class="upload-info">
                                    <small><i class="fas fa-info-circle"></i> Supports PDF files up to 10MB</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Processing Section -->
                <section class="processing-section" id="processingSection">
                    <div class="processing-card">
                        <div class="spinner"></div>
                        <h2>Analyzing Briefing</h2>
                        <p>Extracting data and evaluating against CREATE criteria...</p>
                        <div class="processing-status" id="processingStatus">Initializing...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                </section>

                <!-- Error Section -->
                <section class="error-banner" id="errorBanner">
                    <h3><i class="fas fa-exclamation-triangle"></i> <span id="errorTitle">Processing Error</span></h3>
                    <p id="errorMessage">An error occurred while processing your file.</p>
                    <button class="retry-btn" onclick="handleRetry()">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </section>

                <!-- Results Section -->
                <section class="results-section" id="resultsSection">
                    <div class="decision-banner" id="decisionBanner">
                        <div class="decision-content">
                            <div class="decision-icon" id="decisionIcon"></div>
                            <div class="decision-info">
                                <h2 id="decisionTitle"></h2>
                                <p id="decisionMessage"></p>
                                <div class="decision-score" id="decisionScore"></div>
                            </div>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <button class="btn-secondary" onclick="exportData()">
                                    <i class="fas fa-download"></i>
                                    Export JSON
                                </button>
                                <button class="btn-secondary" onclick="resetDashboard()">
                                    <i class="fas fa-upload"></i>
                                    New Briefing
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Evaluation Details -->
                    <div class="evaluation-grid">
                        <div class="eval-card">
                            <div class="eval-header">
                                <i class="fas fa-euro-sign"></i>
                                <h3>Budget Evaluation</h3>
                            </div>
                            <div class="eval-content">
                                <div class="eval-item">
                                    <label>Minimum Required:</label>
                                    <span class="value highlight">€10,000</span>
                                </div>
                                <div class="eval-item">
                                    <label>Confirmed Budget:</label>
                                    <span class="value" id="confirmedBudget">-</span>
                                </div>
                                <div class="eval-item">
                                    <label>Status:</label>
                                    <span class="status" id="budgetStatus">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="eval-card">
                            <div class="eval-header">
                                <i class="fas fa-clock"></i>
                                <h3>Timeline Evaluation</h3>
                            </div>
                            <div class="eval-content">
                                <div class="eval-item">
                                    <label>Required Lead Time:</label>
                                    <span class="value highlight">10 business days</span>
                                </div>
                                <div class="eval-item">
                                    <label>Proposal Deadline:</label>
                                    <span class="value" id="proposalDeadline">-</span>
                                </div>
                                <div class="eval-item">
                                    <label>Status:</label>
                                    <span class="status" id="timelineStatus">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="eval-card">
                            <div class="eval-header">
                                <i class="fas fa-check-circle"></i>
                                <h3>Required Fields</h3>
                            </div>
                            <div class="eval-content">
                                <div class="eval-item">
                                    <label>Responsible Contact:</label>
                                    <span class="status" id="contactStatus">-</span>
                                </div>
                                <div class="eval-item">
                                    <label>Advertiser Group:</label>
                                    <span class="status" id="advertiserStatus">-</span>
                                </div>
                                <div class="eval-item">
                                    <label>Target Persona:</label>
                                    <span class="status" id="personaStatus">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Extracted Data -->
                    <div class="data-grid">
                        <div class="data-card">
                            <div class="data-header">
                                <i class="fas fa-user-tie"></i>
                                <h3>Contact Information</h3>
                            </div>
                            <div class="data-content">
                                <div class="data-field">
                                    <label>Responsable Commercial</label>
                                    <span id="responsableCommercial">-</span>
                                </div>
                                <div class="data-field">
                                    <label>Agence Média</label>
                                    <span id="agenceMedia">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="data-card">
                            <div class="data-header">
                                <i class="fas fa-building"></i>
                                <h3>Advertiser</h3>
                            </div>
                            <div class="data-content">
                                <div class="data-field">
                                    <label>Group/Annonceur</label>
                                    <span id="groupAnnonceur">-</span>
                                </div>
                                <div class="data-field">
                                    <label>Brand/Product</label>
                                    <span id="brandProduct">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="data-card full-width">
                            <div class="data-header">
                                <i class="fas fa-file-alt"></i>
                                <h3>Brief Details</h3>
                            </div>
                            <div class="data-content grid-3">
                                <div class="data-field">
                                    <label>Target Persona</label>
                                    <span id="targetPersona">-</span>
                                </div>
                                <div class="data-field">
                                    <label>Key Messages</label>
                                    <span id="keyMessages">-</span>
                                </div>
                                <div class="data-field">
                                    <label>Campaign Focus</label>
                                    <span id="sportsFocus">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="data-card full-width">
                            <div class="data-header">
                                <i class="fas fa-sticky-note"></i>
                                <h3>Additional Notes</h3>
                            </div>
                            <div class="data-content">
                                <div class="notes-content" id="additionalNotes">-</div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js" 
            onerror="loadBackupPDFJS()" 
            onload="console.log('✅ PDF.js loaded from primary CDN')"></script>
    <script>
        // Backup PDF.js loading
        function loadBackupPDFJS() {
            console.warn('⚠️ Primary PDF.js CDN failed, trying backup...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js';
            script.onload = function() {
                console.log('✅ PDF.js loaded from backup CDN');
                if (typeof pdfjsLib !== 'undefined') {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
                }
            };
            script.onerror = function() {
                console.error('❌ Both PDF.js CDNs failed');
                if (typeof showPDFError === 'function') {
                    showPDFError('Unable to load PDF processing library from any source.');
                }
            };
            document.head.appendChild(script);
        }
        
        // Simple direct upload handler - works immediately without initialization
        window.directUploadHandler = function() {
            console.log('🚀 Direct upload handler triggered');
            const fileInput = document.getElementById('fileInput');
            
            if (!fileInput) {
                console.error('❌ File input not found');
                return;
            }
            
            // Add event listener directly to file input
            fileInput.addEventListener('change', function(event) {
                console.log('📁 File selected via direct handler!');
                const file = event.target.files[0];
                
                if (!file) {
                    console.log('❌ No file selected');
                    return;
                }
                
                console.log('✅ File details:', {
                    name: file.name,
                    type: file.type,
                    size: file.size
                });
                
                // Basic validation
                if (file.type !== 'application/pdf') {
                    alert('Please select a PDF file. Selected: ' + file.type);
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    alert('File too large. Max 10MB. Your file: ' + Math.round(file.size/1024/1024) + 'MB');
                    return;
                }
                
                // Show processing immediately
                alert('PDF uploaded: ' + file.name + '. Processing would start here...');
                
                // Try to call processFile if it exists
                if (typeof window.processFile === 'function') {
                    console.log('🔄 Calling processFile...');
                    window.processFile(file);
                } else {
                    console.log('❌ processFile function not available');
                    alert('Upload successful but processing function not available. Check console for details.');
                }
            }, { once: true }); // Use once: true to prevent multiple handlers
            
            // Trigger file dialog
            fileInput.click();
        };

        // Debug function to test upload immediately
        window.debugUpload = function() {
            console.log('🔍 DEBUG: Testing upload system...');
            
            // Direct element access
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadArea = document.getElementById('uploadArea');
            
            console.log('- Direct FileInput:', !!fileInput);
            console.log('- Direct UploadBtn:', !!uploadBtn);
            console.log('- Direct UploadArea:', !!uploadArea);
            console.log('- Window Elements:', window.elements);
            console.log('- PDF.js available:', typeof pdfjsLib !== 'undefined');
            
            if (!fileInput) {
                console.error('❌ FileInput not found in DOM!');
                return;
            }
            
            console.log('- FileInput accept:', fileInput.accept);
            console.log('- FileInput disabled:', fileInput.disabled);
            console.log('- FileInput style.display:', fileInput.style.display);
            
            // Add a temporary change handler to test
            const testHandler = function(event) {
                console.log('🎯 TEST HANDLER: File selected!', event.target.files);
                if (event.target.files.length > 0) {
                    const file = event.target.files[0];
                    console.log('File details:', {
                        name: file.name,
                        type: file.type,
                        size: file.size
                    });
                    alert('File selected: ' + file.name + ' (' + file.type + ')');
                }
            };
            
            // Remove existing listeners and add test one
            fileInput.removeEventListener('change', testHandler);
            fileInput.addEventListener('change', testHandler);
            
            // Test direct click
            try {
                fileInput.click();
                console.log('✅ File dialog clicked - should open now');
            } catch (error) {
                console.error('❌ Error clicking file input:', error);
            }
        };

        // Define functions early so they're available for buttons and error handlers
        window.showPDFError = function(message) {
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc2626;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>PDF Processing Unavailable</h3>
                        <p style="margin: 1rem 0;">${message}</p>
                        <button onclick="location.reload()" style="background: #2563eb; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">
                            <i class="fas fa-refresh"></i> Retry
                        </button>
                    </div>
                `;
            } else {
                console.error('PDF Error:', message);
                alert('PDF Error: ' + message);
            }
        };

        window.testDashboard = function() {
            console.log('🧪 Testing dashboard functionality...');
            console.log('📊 Environment Check:');
            console.log('- PDF.js available:', typeof pdfjsLib !== 'undefined');
            console.log('- PDF.js version:', typeof pdfjsLib !== 'undefined' ? pdfjsLib.version : 'N/A');
            console.log('- Worker configured:', typeof pdfjsLib !== 'undefined' ? !!pdfjsLib.GlobalWorkerOptions.workerSrc : false);
            console.log('- Current URL:', window.location.href);
            console.log('- Is HTTPS:', window.location.protocol === 'https:');
            console.log('- Performance timing available:', typeof performance !== 'undefined');
            
            // Test all DOM elements
            console.log('📋 Element Check:');
            Object.entries(window.elements || {}).forEach(([key, element]) => {
                console.log(`- ${key}:`, !!element ? '✅' : '❌');
            });
            
            // Test extraction patterns
            console.log('🔍 Testing extraction patterns...');
            const testText = `
                RESPONSABLE COMMERCIAL: Karolien Van Gaever
                AGENCE MÉDIA: Group M - Essence Mediacom
                ANNONCEUR: Coca-Cola
                MARQUE: Powerade
                CIBLE: 18-54 - sportifs
                BUDGET CONFIRMÉ: 20-25K€
                DATE LIMITE: 01/04/2025
                MESSAGES CLÉS: Choisissez Powerade quand vous faites du sport
                SPORTS: padel, hockey, basket, running
            `;
            
            const testData = {
                contact: 'Test extraction disabled - upload a real PDF to see results',
                agency: null,
                advertiser: null,
                brand: null,
                target: null,
                budget: null,
                date: null,
                sports: null
            };
            
            console.log('🎯 Test Extraction Results:', testData);
            
            // Test CREATE evaluation
            console.log('⚖️ Testing CREATE evaluation...');
            const mockBriefing = {
                meta: { source_file: 'test.pdf', extraction_ts: '2025-08-20' },
                contact: { responsable_commercial: 'Test User', agence_media: 'Test Agency' },
                advertiser: { group_or_annonceur: 'Test Company', brand_or_product: 'Test Product' },
                brief: { target_persona: '18-54 sportifs' },
                constraints: {
                    budget_confirmed_eur_range: '25000-30000',
                    proposal_deadline: '2025-09-15'
                }
            };
            
            const testEvaluation = evaluateCreateCriteria(mockBriefing);
            console.log('📊 Test Evaluation:', testEvaluation);
            
            alert('Dashboard diagnostics complete! All systems tested. Check console for detailed results.');
        };

        window.simulateProcessing = function() {
            console.log('🎭 Simulating processing flow...');
            showProcessing();
            startProgressAnimation();
            
            let step = 0;
            const steps = [
                { status: 'Reading PDF...', progress: 20 },
                { status: 'Extracting text...', progress: 40 },
                { status: 'Analyzing content...', progress: 60 },
                { status: 'Evaluating criteria...', progress: 80 },
                { status: 'Finalizing results...', progress: 100 }
            ];
            
            const interval = setInterval(() => {
                if (step < steps.length) {
                    updateStatus(steps[step].status);
                    setProgress(steps[step].progress);
                    step++;
                } else {
                    clearInterval(interval);
                    stopProgressAnimation();
                    
                    // Show mock results
                    setTimeout(() => {
                        const mockData = {
                            briefing: {
                                meta: { source_file: 'test.pdf', extraction_ts: '2025-08-20' },
                                contact: { responsable_commercial: 'Test User', agence_media: 'Test Agency' },
                                advertiser: { group_or_annonceur: 'Test Company', brand_or_product: 'Test Product' },
                                brief: { target_persona: '18-54 sportifs', key_messages: 'Test message', sports_focus: ['padel', 'running'], notes: 'Test notes' },
                                constraints: { budget_confirmed_eur_range: '25000-30000', proposal_deadline: '2025-09-15' }
                            }
                        };
                        
                        const mockEvaluation = {
                            overall_decision: 'GO',
                            score: 85,
                            max_score: 100,
                            criteria: {
                                budget: { status: 'PASS', score: 40, message: '€25,000 ≥ €10,000' },
                                timeline: { status: 'PASS', score: 30, message: '26 days ≥ 10 days' },
                                required_fields: { status: 'PASS', score: 30, message: 'All required fields present' }
                            }
                        };
                        
                        window.currentData = { briefing: mockData.briefing, evaluation: mockEvaluation };
                        showResults(mockData.briefing, mockEvaluation);
                    }, 500);
                }
            }, 1000);
        };
    </script>
    <script>
        // Brand Studio CREATE Dashboard
        console.log('🚀 Dashboard Loading...');

        // Configuration
        const CONFIG = {
            PDF_WORKER_URL: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js',
            MAX_FILE_SIZE: 10 * 1024 * 1024,
            CREATE_RULES: {
                MIN_BUDGET: 10000,
                MIN_LEAD_TIME_DAYS: 10,
                REQUIRED_FIELDS: ['responsable_commercial', 'group_annonceur', 'target_persona']
            }
        };

        // Global state - accessible to all functions
        window.isProcessing = false;
        window.currentData = null;
        window.elements = {};
        window.lastFile = null;
        window.progressInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📋 DOM Ready');
            console.log('🌐 Current URL:', window.location.href);
            console.log('🔧 User Agent:', navigator.userAgent);
            
            // Enhanced PDF.js loading check
            if (typeof pdfjsLib !== 'undefined') {
                console.log('✅ PDF.js loaded successfully');
                console.log('📋 PDF.js version:', pdfjsLib.version);
                
                try {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = CONFIG.PDF_WORKER_URL;
                    console.log('📚 PDF.js worker configured:', CONFIG.PDF_WORKER_URL);
                    initDashboard();
                } catch (workerError) {
                    console.error('❌ PDF.js worker configuration failed:', workerError);
                    showPDFError('PDF.js worker configuration failed. This may be due to security restrictions.');
                }
            } else {
                console.error('❌ PDF.js failed to load from CDN');
                console.log('🔍 Checking network and security policies...');
                showPDFError('PDF.js library failed to load. Please check your internet connection and try refreshing the page.');
            }
        });


        function initDashboard() {
            // Get elements
            window.elements = {
                fileInput: document.getElementById('fileInput'),
                uploadBtn: document.getElementById('uploadBtn'),
                uploadArea: document.getElementById('uploadArea'),
                uploadSection: document.getElementById('uploadSection'),
                processingSection: document.getElementById('processingSection'),
                processingStatus: document.getElementById('processingStatus'),
                progressFill: document.getElementById('progressFill'),
                resultsSection: document.getElementById('resultsSection'),
                decisionBanner: document.getElementById('decisionBanner'),
                errorBanner: document.getElementById('errorBanner'),
                errorTitle: document.getElementById('errorTitle'),
                errorMessage: document.getElementById('errorMessage')
            };

            // Check elements
            for (const [key, element] of Object.entries(window.elements)) {
                if (!element) {
                    console.error(`❌ Missing element: ${key}`);
                    return;
                }
            }

            setupEventListeners();
            console.log('✅ Dashboard ready');
        }

        function setupEventListeners() {
            const { fileInput, uploadBtn, uploadArea } = window.elements;

            console.log('🎧 Setting up event listeners...');
            console.log('Elements found:', {
                fileInput: !!fileInput,
                uploadBtn: !!uploadBtn, 
                uploadArea: !!uploadArea
            });

            // Check if elements exist before adding listeners
            if (!fileInput || !uploadBtn || !uploadArea) {
                console.error('❌ Critical elements missing:', { fileInput: !!fileInput, uploadBtn: !!uploadBtn, uploadArea: !!uploadArea });
                return;
            }

            // CRITICAL: File input change handler
            fileInput.addEventListener('change', function(event) {
                const startTime = performance.now();
                console.log('📁 File input CHANGED event fired!');
                console.log('Files selected:', event.target.files.length);
                
                const file = event.target.files[0];
                if (file) {
                    console.log('✅ File found:', file.name, file.type, file.size + ' bytes');
                    event.preventDefault();
                    event.stopPropagation();
                    window.processFile(file);
                } else {
                    console.log('❌ No file in event.target.files');
                }
                
                const endTime = performance.now();
                console.log(`⏱️ File input handler took ${endTime - startTime}ms`);
            }, false);

            // Button click handler  
            uploadBtn.addEventListener('click', function(event) {
                const startTime = performance.now();
                event.preventDefault();
                event.stopPropagation();
                console.log('🔘 Upload button clicked - opening file dialog');
                
                // Reset file input to ensure change event fires
                fileInput.value = '';
                fileInput.click();
                
                const endTime = performance.now();
                console.log(`⏱️ Button click handler took ${endTime - startTime}ms`);
                console.log('File dialog should be open now...');
            }, false);

            // Upload area click handler
            uploadArea.addEventListener('click', function(event) {
                // Don't prevent default if clicking on the button itself
                if (event.target === uploadBtn || uploadBtn.contains(event.target)) {
                    return;
                }
                
                event.preventDefault();
                event.stopPropagation();
                console.log('📦 Upload area clicked - opening file dialog');
                
                if (!window.isProcessing) {
                    fileInput.value = '';
                    fileInput.click();
                }
            }, false);

            // Drag and drop handlers
            uploadArea.addEventListener('dragover', function(event) {
                event.preventDefault();
                event.stopPropagation();
                uploadArea.classList.add('dragging');
                console.log('📥 Drag over upload area');
            }, false);

            uploadArea.addEventListener('dragleave', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                // Only remove dragging class if we're really leaving the upload area
                if (!uploadArea.contains(event.relatedTarget)) {
                    uploadArea.classList.remove('dragging');
                    console.log('📤 Drag left upload area');
                }
            }, false);

            uploadArea.addEventListener('drop', function(event) {
                event.preventDefault();
                event.stopPropagation();
                uploadArea.classList.remove('dragging');
                
                console.log('📥 File dropped on upload area!');
                
                const files = event.dataTransfer.files;
                console.log('Dropped files count:', files.length);
                
                if (files.length > 0) {
                    const file = files[0];
                    console.log('✅ Processing dropped file:', file.name, file.type);
                    window.processFile(file);
                } else {
                    console.log('❌ No files in drop event');
                }
            }, false);

            // Global drag prevention (but allow our drop zone)
            document.addEventListener('dragover', function(event) {
                event.preventDefault();
            }, false);
            
            document.addEventListener('drop', function(event) {
                // Only prevent default if NOT dropping on our upload area
                if (!uploadArea.contains(event.target)) {
                    event.preventDefault();
                    console.log('🚫 Prevented default drop outside upload area');
                }
            }, false);

            console.log('✅ All event listeners configured successfully');
        }

        // File processing - make it globally accessible
        window.processFile = async function processFile(file) {
            const processStartTime = performance.now();
            console.log('🚀 processFile() called with:', file ? file.name : 'null file');
            
            if (window.isProcessing) {
                console.log('⏳ Already processing a file - ignoring new request');
                return;
            }

            console.log('🔄 Starting file processing...');
            console.log('File details:', {
                name: file ? file.name : 'N/A',
                size: file ? file.size : 'N/A',
                type: file ? file.type : 'N/A',
                lastModified: file ? new Date(file.lastModified).toISOString() : 'N/A'
            });

            // Validate file exists
            if (!file) {
                console.error('❌ No file provided to processFile()');
                alert('No file selected.');
                return;
            }

            // Validate file type
            if (file.type !== 'application/pdf') {
                console.error('❌ Invalid file type:', file.type);
                alert('Please upload a PDF file only. Selected file type: ' + file.type);
                return;
            }

            // Validate file size
            if (file.size > CONFIG.MAX_FILE_SIZE) {
                console.error('❌ File too large:', file.size, 'bytes, max:', CONFIG.MAX_FILE_SIZE);
                alert('File too large. Max 10MB. Your file: ' + Math.round(file.size/1024/1024) + 'MB');
                return;
            }

            if (file.size === 0) {
                console.error('❌ Empty file');
                alert('File is empty.');
                return;
            }

            console.log('✅ File validation passed - starting processing...');
            window.isProcessing = true;
            
            // Add visual feedback immediately
            window.elements.uploadArea.classList.add('form-loading');
            window.elements.uploadBtn.disabled = true;
            window.elements.uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            try {
                // Show processing
                showProcessing();
                window.lastFile = file;
                
                // Start progress tracking
                startProgressAnimation();
                
                updateStatus('Reading PDF...');
                setProgress(10);

                // Extract text
                const text = await extractPDFText(file);
                console.log(`📝 Extracted ${text.length} characters`);
                setProgress(40);

                updateStatus('Analyzing content...');
                await delay(500);

                // Extract data
                const briefingData = extractBriefingData(text, file.name);
                console.log('📊 Data:', briefingData);
                setProgress(70);

                updateStatus('Evaluating CREATE criteria...');
                await delay(500);

                // Evaluate
                const evaluation = evaluateCreateCriteria(briefingData);
                console.log('🎯 Evaluation:', evaluation);
                setProgress(90);

                updateStatus('Finalizing results...');
                await delay(300);
                setProgress(100);

                // Store and display
                window.currentData = { briefing: briefingData, evaluation };
                stopProgressAnimation();
                showResults(briefingData, evaluation);

                const processEndTime = performance.now();
                console.log(`⏱️ Total file processing took ${processEndTime - processStartTime}ms`);

            } catch (error) {
                console.error('💥 Error:', error);
                const processEndTime = performance.now();
                console.log(`⏱️ File processing failed after ${processEndTime - processStartTime}ms`);
                
                stopProgressAnimation();
                showError(error);
                hideProcessing();
            } finally {
                window.isProcessing = false;
            }
        }

        // PDF text extraction
        async function extractPDFText(file) {
            try {
                console.log('📖 Starting PDF text extraction...');
                const arrayBuffer = await file.arrayBuffer();
                console.log(`📄 PDF loaded, size: ${arrayBuffer.byteLength} bytes`);
                
                const pdf = await pdfjsLib.getDocument({
                    data: arrayBuffer,
                    verbosity: 0
                }).promise;
                
                console.log(`📋 PDF has ${pdf.numPages} pages`);
                let fullText = '';
                let pagesProcessed = 0;

                for (let i = 1; i <= pdf.numPages; i++) {
                    try {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        
                        const pageText = content.items
                            .filter(item => item.str && item.str.trim())
                            .map(item => item.str.trim())
                            .join(' ')
                            .replace(/\s+/g, ' ');

                        if (pageText.trim()) {
                            fullText += pageText + '\n\n';
                            pagesProcessed++;
                        }
                        
                        console.log(`📄 Page ${i} processed: ${pageText.length} characters`);
                    } catch (pageError) {
                        console.warn(`⚠️ Page ${i} error:`, pageError.message);
                        // Continue with other pages
                    }
                }

                console.log(`✅ Text extraction complete: ${pagesProcessed}/${pdf.numPages} pages, ${fullText.length} characters`);

                if (!fullText.trim()) {
                    throw new Error('No readable text found in PDF. The PDF may be image-based or encrypted.');
                }

                return fullText.trim();

            } catch (error) {
                console.error('💥 PDF extraction error:', error);
                if (error.name === 'InvalidPDFException') {
                    throw new Error('Invalid PDF file. Please check that the file is not corrupted.');
                } else if (error.name === 'PasswordException') {
                    throw new Error('PDF is password protected. Please provide an unlocked version.');
                } else {
                    throw new Error(`Cannot read PDF: ${error.message}`);
                }
            }
        }

        // Extract briefing data with simple, safe patterns
        function extractBriefingData(text, fileName) {
            console.log('🔍 Extracting data from text length:', text.length);
            
            // Simple, safe extraction patterns
            const extractSimple = (text, keywords) => {
                for (const keyword of keywords) {
                    if (text.toLowerCase().includes(keyword.toLowerCase())) {
                        const regex = new RegExp(keyword + '\\s*:?\\s*([A-Za-z0-9\\s.,-]+)', 'i');
                        const match = text.match(regex);
                        if (match && match[1]) {
                            return match[1].trim().substring(0, 100);
                        }
                    }
                }
                return null;
            };
            
            return {
                meta: {
                    source_file: fileName,
                    extraction_ts: new Date().toISOString().split('T')[0]
                },
                contact: {
                    responsable_commercial: extractSimple(text, ['responsable commercial', 'contact', 'karolien van gaever']),
                    agence_media: extractSimple(text, ['agence media', 'media agency', 'group m', 'essence mediacom'])
                },
                advertiser: {
                    group_or_annonceur: extractSimple(text, ['annonceur', 'client', 'advertiser', 'coca-cola', 'oneplus']),
                    brand_or_product: extractSimple(text, ['marque', 'produit', 'brand', 'product', 'powerade'])
                },
                brief: {
                    type: extractSimple(text, ['type brief', 'typologie']),
                    urgency: null,
                    typologie_annonceur: extractSimple(text, ['typologie annonceur', 'type client']),
                    presentation_languages: text.includes('français') || text.includes('anglais') ? ['Français'] : null,
                    attachments_present: null,
                    target_persona: extractSimple(text, ['cible', 'persona', 'target', 'doelgroep', 'studenten', 'sportifs']) || 
                                   (text.match(/\d{1,2}[-–]\d{1,2}[^0-9]*sportifs/i) ? text.match(/\d{1,2}[-–]\d{1,2}[^0-9]*sportifs/i)[0] : null),
                    objectives: text.includes('awareness') ? ['awareness'] : null,
                    start_momentum_reason: null,
                    end_date: null,
                    key_messages: extractSimple(text, ['messages clés', 'message principal', 'choisissez powerade']),
                    media_specific_preferences: null,
                    history_with_rossel: null,
                    other_campaigns_with_rossel: null,
                    notes: extractSimple(text, ['complément', 'notes', 'intérêt pour'])
                },
                constraints: {
                    min_budget_create_eur: 10000,
                    budget_confirmed_eur_range: text.match(/(\d+)[-–](\d+)\s*k/i) ? 
                        `${parseInt(text.match(/(\d+)[-–](\d+)\s*k/i)[1]) * 1000}-${parseInt(text.match(/(\d+)[-–](\d+)\s*k/i)[2]) * 1000}` : null,
                    proposal_deadline: text.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/)?.[0] ? 
                        new Date(text.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/)[3], text.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/)[2] - 1, text.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/)[1]).toISOString().split('T')[0] : null,
                    lead_time_business_days_after_valid_brief: 10,
                    do_not: text.includes('pas de native') ? ['native'] : null,
                    prefer: text.includes('plutôt digital') ? ['digital'] : null
                },
                creative: {
                    sports_focus: ['padel', 'hockey', 'basket', 'running'].filter(sport => text.toLowerCase().includes(sport)),
                    audience_activity_min_sessions_per_week: text.match(/(\d+)\s*[x×]\s*\/\s*semaine/i) ? parseInt(text.match(/(\d+)\s*[x×]\s*\/\s*semaine/i)[1]) : null
                }
            };
        }

        function extractPattern(text, patterns) {
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    const result = match[1] || match[0];
                    return cleanText(result);
                }
            }
            return null;
        }

        function cleanText(text) {
            return text.trim()
                .replace(/\\s+/g, ' ')
                .replace(/^[:\\-]\\s*/, '')
                .substring(0, 200);
        }

        function extractBudget(text) {
            const patterns = [
                /budget[\\s\\w]*confirmé[\\s]*:?\\s*€?\\s*(\\d+(?:[.,]\\d{3})*(?:k|K)?)/i,
                /budget[\\s\\w]*disponible[\\s]*:?\\s*€?\\s*(\\d+(?:[.,]\\d{3})*(?:k|K)?)/i,
                /(\\d+)[-–](\\d+)\\s*k/i,
                /(\\d+)[k|K][-–](\\d+)[k|K]/i,
                /€\\s*(\\d{1,3})[.,](\\d{3})/i,
                /budget[\\s]*:?\\s*€?\\s*(\\d+)/i
            ];

            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    if (match[2]) {
                        // Range pattern like "20-25k"
                        let low = parseInt(match[1]) || 0;
                        let high = parseInt(match[2]) || 0;
                        if (match[0].toLowerCase().includes('k')) {
                            low *= 1000;
                            high *= 1000;
                        }
                        return `${low}-${high}`;
                    } else {
                        // Single value
                        let amount = parseInt(match[1].replace(/[.,]/g, '')) || 0;
                        if (match[0].toLowerCase().includes('k')) {
                            amount *= 1000;
                        }
                        return amount.toString();
                    }
                }
            }
            return null;
        }

        function extractDate(text, type = 'any') {
            const patterns = [
                /(\\d{1,2})\\s+(augustus|september|janvier|f[eé]vrier|mars|avril|mai|juin|juillet|ao[uû]t|octobre|novembre|d[eé]cembre)\\s+(\\d{4})/i,
                /(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})/g,
                /(\\d{1,2})[-](\\d{1,2})[-](\\d{4})/g
            ];

            for (const pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    try {
                        if (match[2] && isNaN(match[2])) {
                            // Month name format
                            const monthMap = { 
                                'augustus': 8, 'september': 9, 'janvier': 1, 'février': 2, 'mars': 3, 
                                'avril': 4, 'mai': 5, 'juin': 6, 'juillet': 7, 'août': 8, 'aout': 8,
                                'octobre': 10, 'novembre': 11, 'décembre': 12, 'december': 12
                            };
                            const month = monthMap[match[2].toLowerCase()];
                            if (month) {
                                return new Date(match[3], month - 1, match[1]).toISOString().split('T')[0];
                            }
                        } else {
                            // Numeric format
                            const [, day, month, year] = match;
                            return new Date(year, month - 1, day).toISOString().split('T')[0];
                        }
                    } catch (e) {
                        continue;
                    }
                }
            }
            return null;
        }

        function extractUrgency(text) {
            const urgencyPatterns = [
                /urgence[\\s]*:?\\s*(faible|moyen|[eé]lev[eé])/i
            ];
            for (const pattern of urgencyPatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    const level = match[1].toLowerCase();
                    if (level.includes('faible')) return 'faible';
                    if (level.includes('moyen')) return 'moyen';
                    if (level.includes('lev')) return 'eleve';
                }
            }
            return null;
        }

        function extractLanguages(text) {
            const languages = [];
            if (/français/i.test(text)) languages.push('Français');
            if (/anglais|english/i.test(text)) languages.push('Anglais');  
            if (/néerlandais|dutch/i.test(text)) languages.push('Néerlandais');
            return languages.length > 0 ? languages : null;
        }

        function extractAttachments(text) {
            if (/attachments?[\\s\\w]*:?\\s*(yes|oui|ja)/i.test(text)) return true;
            if (/attachments?[\\s\\w]*:?\\s*(no|non|nee)/i.test(text)) return false;
            return null;
        }

        function extractObjectives(text) {
            const objectives = [];
            if (/awareness|notori[eé]t[eé]/i.test(text)) objectives.push('awareness');
            if (/consideration|consid[eé]ration/i.test(text)) objectives.push('consideration');
            if (/activation|conversion/i.test(text)) objectives.push('activation_conversion');
            return objectives.length > 0 ? objectives : null;
        }

        function extractMediaPreferences(text) {
            const mediaPrefs = [];
            const medias = ['le soir', 'sudinfo', 'kotplanet', 'references', 'dh'];
            medias.forEach(media => {
                if (new RegExp(media, 'i').test(text)) {
                    mediaPrefs.push(media);
                }
            });
            return mediaPrefs.length > 0 ? mediaPrefs : null;
        }

        function extractDoNot(text) {
            const doNotList = [];
            if (/pas[\\s]+de[\\s]+native|no[\\s]+native/i.test(text)) doNotList.push('native');
            if (/pas[\\s]+d[\'']?influenceurs?|no[\\s]+influencers?/i.test(text)) doNotList.push('influenceurs');
            return doNotList.length > 0 ? doNotList : null;
        }

        function extractPrefer(text) {
            const preferList = [];
            if (/plut[ôo]t[\\s]+digital|prefer[\\s]+digital/i.test(text)) preferList.push('digital');
            return preferList.length > 0 ? preferList : null;
        }

        function extractMinSessions(text) {
            const sessionMatch = text.match(/([0-9]+)[\\s]*[x×][\\s]*\\/[\\s]*semaine|([0-9]+)[\\s]*fois?[\\s]*par[\\s]*semaine/i);
            if (sessionMatch) {
                return parseInt(sessionMatch[1] || sessionMatch[2]);
            }
            return null;
        }

        function extractSportsFocus(text) {
            const sportsKeywords = [
                'padel', 'hockey', 'basket', 'basketball', 'running', 'football', 'soccer', 
                'tennis', 'volleyball', 'fitness', 'gym', 'sport', 'sports', 'sportif', 'sportifs',
                'cyclisme', 'natation', 'swimming', 'jogging', 'musculation'
            ];
            
            const found = sportsKeywords.filter(sport => 
                new RegExp('\\b' + sport + '\\b', 'i').test(text)
            );
            
            // Also look for specific sports mentions in context
            const sportsMatches = text.match(/int[eé]r[eê]t\\s+pour\\s+([^.]+)/i);
            if (sportsMatches) {
                const sportsText = sportsMatches[1].toLowerCase();
                const additionalSports = sportsKeywords.filter(sport => 
                    sportsText.includes(sport)
                );
                found.push(...additionalSports.filter(s => !found.includes(s)));
            }
            
            return found.length > 0 ? found : null;
        }

        function extractNotes(text) {
            const patterns = [
                /awareness[\\s\\w]*:?\\s*([^\\n.]{30,200})/i,
                /doelstelling[\\s\\w]*:?\\s*([^\\n.]{30,200})/i,
                /detail[\\s\\w]*:?\\s*([^\\n.]{30,200})/i
            ];

            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    return cleanText(match[1]);
                }
            }
            return null;
        }

        // CREATE evaluation using claude.md schema
        function evaluateCreateCriteria(data) {
            const evaluation = {
                overall_decision: 'PENDING',
                score: 0,
                max_score: 100,
                criteria: {
                    budget: { status: 'FAIL', score: 0, message: '' },
                    timeline: { status: 'FAIL', score: 0, message: '' },
                    required_fields: { status: 'FAIL', score: 0, message: '' }
                },
                issues: []
            };

            // Budget (40 points) - use budget_confirmed_eur_range
            if (data.constraints.budget_confirmed_eur_range) {
                const budgetRange = data.constraints.budget_confirmed_eur_range;
                let minBudget;
                
                if (budgetRange.includes('-')) {
                    minBudget = parseInt(budgetRange.split('-')[0]);
                } else {
                    minBudget = parseInt(budgetRange);
                }
                
                const required = data.constraints.min_budget_create_eur;

                if (minBudget >= required) {
                    evaluation.criteria.budget = {
                        status: 'PASS',
                        score: 40,
                        message: `€${minBudget.toLocaleString()} ≥ €${required.toLocaleString()}`
                    };
                } else {
                    evaluation.criteria.budget = {
                        status: 'FAIL',
                        score: 0,
                        message: `€${minBudget.toLocaleString()} < €${required.toLocaleString()}`
                    };
                    evaluation.issues.push('Budget below CREATE minimum');
                }
            } else {
                evaluation.criteria.budget = {
                    status: 'FAIL',
                    score: 0,
                    message: 'No budget confirmed'
                };
                evaluation.issues.push('Budget not found');
            }

            // Timeline (30 points)
            if (data.constraints.proposal_deadline) {
                const deadline = new Date(data.constraints.proposal_deadline);
                const today = new Date();
                const days = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                const required = data.constraints.lead_time_business_days_after_valid_brief;

                if (days >= required) {
                    evaluation.criteria.timeline = {
                        status: 'PASS',
                        score: 30,
                        message: `${days} days ≥ ${required} days`
                    };
                } else {
                    evaluation.criteria.timeline = {
                        status: 'FAIL',
                        score: 0,
                        message: `${days} days < ${required} days`
                    };
                    evaluation.issues.push('Insufficient lead time');
                }
            } else {
                evaluation.criteria.timeline = {
                    status: 'FAIL',
                    score: 0,
                    message: 'No deadline found'
                };
                evaluation.issues.push('Missing deadline');
            }

            // Required fields (30 points) - check key fields from claude.md
            const requiredFields = ['responsable_commercial', 'group_or_annonceur', 'target_persona'];
            const missing = [];

            if (!data.contact.responsable_commercial) missing.push('Responsable Commercial');
            if (!data.advertiser.group_or_annonceur) missing.push('Group/Annonceur'); 
            if (!data.brief.target_persona) missing.push('Target Persona');

            if (missing.length === 0) {
                evaluation.criteria.required_fields = {
                    status: 'PASS',
                    score: 30,
                    message: 'All required fields present'
                };
            } else {
                evaluation.criteria.required_fields = {
                    status: 'FAIL',
                    score: Math.max(0, 30 - (missing.length * 10)),
                    message: `Missing: ${missing.join(', ')}`
                };
                evaluation.issues.push(`Missing: ${missing.join(', ')}`);
            }

            // Calculate score
            evaluation.score = Object.values(evaluation.criteria)
                .reduce((total, criterion) => total + criterion.score, 0);

            // Final decision
            const criticalPassed = evaluation.criteria.budget.status === 'PASS' && 
                                   evaluation.criteria.timeline.status === 'PASS';

            if (criticalPassed && evaluation.score >= 80) {
                evaluation.overall_decision = 'GO';
            } else if (criticalPassed && evaluation.score >= 60) {
                evaluation.overall_decision = 'CONDITIONAL';
            } else {
                evaluation.overall_decision = 'NO-GO';
            }

            return evaluation;
        }

        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => {
                if (current && current[key] !== undefined && current[key] !== null) {
                    return current[key];
                }
                const parts = key.split('_');
                if (parts.length > 1) {
                    let value = current;
                    for (const part of parts) {
                        if (value && value[part] !== undefined && value[part] !== null) {
                            value = value[part];
                        } else {
                            return null;
                        }
                    }
                    return value;
                }
                return null;
            }, obj);
        }

        // UI functions
        function showProcessing() {
            window.elements.uploadSection.style.display = 'none';
            window.elements.processingSection.style.display = 'flex';
            window.elements.resultsSection.style.display = 'none';
        }

        function updateStatus(message) {
            window.elements.processingStatus.textContent = message;
        }

        function showResults(briefingData, evaluation) {
            window.elements.uploadSection.style.display = 'none';
            window.elements.processingSection.style.display = 'none';
            window.elements.resultsSection.style.display = 'block';

            displayDecisionBanner(evaluation);
            displayEvaluationDetails(evaluation);
            displayExtractedData(briefingData);
        }

        function displayDecisionBanner(evaluation) {
            const banner = window.elements.decisionBanner;
            const icon = document.getElementById('decisionIcon');
            const title = document.getElementById('decisionTitle');
            const message = document.getElementById('decisionMessage');
            const score = document.getElementById('decisionScore');

            banner.className = 'decision-banner';

            if (evaluation.overall_decision === 'GO') {
                banner.classList.add('go');
                icon.innerHTML = '<i class="fas fa-check"></i>';
                title.textContent = 'GO - Brief Approved';
                message.textContent = 'All CREATE criteria met.';
            } else if (evaluation.overall_decision === 'CONDITIONAL') {
                banner.classList.add('nogo');
                icon.innerHTML = '<i class="fas fa-exclamation"></i>';
                title.textContent = 'CONDITIONAL - Review Required';
                message.textContent = 'Core criteria met but needs review.';
            } else {
                banner.classList.add('nogo');
                icon.innerHTML = '<i class="fas fa-times"></i>';
                title.textContent = 'NO-GO - Brief Rejected';
                message.textContent = 'CREATE criteria not met.';
            }

            score.textContent = `Score: ${evaluation.score}/${evaluation.max_score}`;
        }

        function displayEvaluationDetails(evaluation) {
            // Budget
            const budgetStatus = document.getElementById('budgetStatus');
            const confirmedBudget = document.getElementById('confirmedBudget');

            budgetStatus.className = evaluation.criteria.budget.status === 'PASS' ? 'status valid' : 'status invalid';
            budgetStatus.textContent = evaluation.criteria.budget.status === 'PASS' ? '✓ Valid' : '✗ Invalid';

            if (window.currentData.briefing.constraints.budget_confirmed_eur_range) {
                const budget = window.currentData.briefing.constraints.budget_confirmed_eur_range;
                if (budget.includes('-')) {
                    const [low, high] = budget.split('-');
                    confirmedBudget.textContent = `€${parseInt(low).toLocaleString()}-€${parseInt(high).toLocaleString()}`;
                } else {
                    confirmedBudget.textContent = `€${parseInt(budget).toLocaleString()}`;
                }
            } else {
                confirmedBudget.textContent = 'Not specified';
                confirmedBudget.classList.add('text-muted');
            }

            // Timeline
            const timelineStatus = document.getElementById('timelineStatus');
            const proposalDeadline = document.getElementById('proposalDeadline');

            timelineStatus.className = evaluation.criteria.timeline.status === 'PASS' ? 'status valid' : 'status invalid';
            timelineStatus.textContent = evaluation.criteria.timeline.status === 'PASS' ? '✓ Adequate' : '✗ Insufficient';

            if (window.currentData.briefing.constraints.proposal_deadline) {
                const deadline = new Date(window.currentData.briefing.constraints.proposal_deadline);
                proposalDeadline.textContent = deadline.toLocaleDateString();
            } else {
                proposalDeadline.textContent = 'Not specified';
                proposalDeadline.classList.add('text-muted');
            }

            // Required fields - using claude.md field names
            const contactStatus = document.getElementById('contactStatus');
            const advertiserStatus = document.getElementById('advertiserStatus');
            const personaStatus = document.getElementById('personaStatus');

            contactStatus.className = window.currentData.briefing.contact.responsable_commercial ? 'status valid' : 'status missing';
            contactStatus.textContent = window.currentData.briefing.contact.responsable_commercial ? '✓ Found' : '⚠ Missing';

            advertiserStatus.className = window.currentData.briefing.advertiser.group_or_annonceur ? 'status valid' : 'status missing';
            advertiserStatus.textContent = window.currentData.briefing.advertiser.group_or_annonceur ? '✓ Found' : '⚠ Missing';

            personaStatus.className = window.currentData.briefing.brief.target_persona ? 'status valid' : 'status missing';
            personaStatus.textContent = window.currentData.briefing.brief.target_persona ? '✓ Found' : '⚠ Missing';
        }

        function displayExtractedData(data) {
            // Contact info
            setFieldValue('responsableCommercial', data.contact.responsable_commercial);
            setFieldValue('agenceMedia', data.contact.agence_media);
            
            // Advertiser info - using claude.md field names
            setFieldValue('groupAnnonceur', data.advertiser.group_or_annonceur);
            setFieldValue('brandProduct', data.advertiser.brand_or_product);
            
            // Brief details
            setFieldValue('targetPersona', data.brief.target_persona);
            setFieldValue('keyMessages', data.brief.key_messages);
            setFieldValue('sportsFocus', data.creative.sports_focus?.join(', '));
            setFieldValue('additionalNotes', data.brief.notes);
        }

        function setFieldValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value || '-';
                if (!value) {
                    element.classList.add('text-muted');
                } else {
                    element.classList.remove('text-muted');
                }
            }
        }

        function resetToUpload() {
            window.elements.uploadSection.style.display = 'block';
            window.elements.processingSection.style.display = 'none';
            window.elements.resultsSection.style.display = 'none';

            window.elements.fileInput.value = '';
            window.elements.uploadArea.classList.remove('dragging', 'form-loading');
            window.elements.uploadBtn.disabled = false;
            window.elements.uploadBtn.innerHTML = '<i class="fas fa-plus"></i> Choose PDF File';

            window.currentData = null;
            window.isProcessing = false;
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Progress and error handling functions
        function startProgressAnimation() {
            if (window.progressInterval) clearInterval(window.progressInterval);
            let progress = 0;
            window.progressInterval = setInterval(() => {
                progress = Math.min(progress + Math.random() * 2, 95);
                if (window.elements.progressFill) {
                    window.elements.progressFill.style.width = progress + '%';
                }
            }, 100);
        }

        function stopProgressAnimation() {
            if (window.progressInterval) {
                clearInterval(window.progressInterval);
                window.progressInterval = null;
            }
        }

        function setProgress(percentage) {
            if (window.elements.progressFill) {
                window.elements.progressFill.style.width = percentage + '%';
            }
        }

        function showError(error) {
            if (window.elements.errorBanner) {
                window.elements.errorTitle.textContent = getErrorTitle(error);
                window.elements.errorMessage.textContent = getErrorMessage(error);
                window.elements.errorBanner.classList.add('show');
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    hideError();
                }, 10000);
            }
        }

        function hideError() {
            if (window.elements.errorBanner) {
                window.elements.errorBanner.classList.remove('show');
            }
        }

        function hideProcessing() {
            window.elements.processingSection.style.display = 'none';
        }

        function getErrorTitle(error) {
            if (error.name === 'InvalidPDFException') return 'Invalid PDF File';
            if (error.name === 'PasswordException') return 'Password Protected PDF';
            if (error.message.includes('network') || error.message.includes('fetch')) return 'Network Error';
            if (error.message.includes('memory') || error.message.includes('size')) return 'File Too Large';
            return 'Processing Error';
        }

        function getErrorMessage(error) {
            if (error.name === 'InvalidPDFException') {
                return 'The uploaded file is not a valid PDF or may be corrupted. Please check the file and try again.';
            }
            if (error.name === 'PasswordException') {
                return 'This PDF is password protected. Please provide an unlocked version of the file.';
            }
            if (error.message.includes('network') || error.message.includes('fetch')) {
                return 'Unable to load required resources. Please check your internet connection and try again.';
            }
            if (error.message.includes('memory') || error.message.includes('size')) {
                return 'The file is too large to process. Please try with a smaller PDF file (under 10MB).';
            }
            return error.message || 'An unexpected error occurred while processing your file.';
        }

        function handleRetry() {
            hideError();
            if (window.lastFile) {
                console.log('🔄 Retrying with last file:', window.lastFile.name);
                window.processFile(window.lastFile);
            } else {
                resetToUpload();
            }
        }

        function resetDashboard() {
            console.log('🔄 Reset');
            hideError();
            window.lastFile = null;
            resetToUpload();
        }

        window.resetDashboard = resetDashboard;

        // Export functionality
        function exportData() {
            if (!window.currentData || !window.currentData.briefing) {
                alert('No data to export. Please process a PDF first.');
                return;
            }

            // Transform data to match CLAUDE.md schema exactly
            const exportData = transformToClaudeSchema(window.currentData.briefing);
            
            // Create download
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `briefing-${window.currentData.briefing.meta.source_file.replace('.pdf', '')}-${window.currentData.briefing.meta.extraction_ts}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            console.log('📤 Data exported:', exportFileDefaultName);
        }

        function transformToClaudeSchema(briefingData) {
            return {
                meta: {
                    source_file: briefingData.meta.source_file,
                    extraction_ts: briefingData.meta.extraction_ts || briefingData.meta.extraction_date
                },
                contact: {
                    responsable_commercial: briefingData.contact.responsable_commercial,
                    agence_media: briefingData.contact.agence_media
                },
                advertiser: {
                    group_or_annonceur: briefingData.advertiser.group_annonceur || briefingData.advertiser.group_or_annonceur,
                    brand_or_product: briefingData.advertiser.brand_product || briefingData.advertiser.brand_or_product
                },
                brief: {
                    type: briefingData.brief.type || null,
                    urgency: briefingData.brief.urgency || null,
                    typologie_annonceur: briefingData.brief.typologie_annonceur || null,
                    presentation_languages: briefingData.brief.presentation_languages || null,
                    attachments_present: briefingData.brief.attachments_present || null,
                    target_persona: briefingData.brief.target_persona,
                    objectives: briefingData.brief.objectives || null,
                    start_momentum_reason: briefingData.brief.start_momentum_reason || null,
                    end_date: briefingData.brief.end_date || null,
                    key_messages: briefingData.brief.key_messages,
                    media_specific_preferences: briefingData.brief.media_specific_preferences || null,
                    history_with_rossel: briefingData.brief.history_with_rossel || null,
                    other_campaigns_with_rossel: briefingData.brief.other_campaigns_with_rossel || null,
                    notes: briefingData.brief.notes
                },
                constraints: {
                    min_budget_create_eur: 10000,
                    budget_confirmed_eur_range: briefingData.constraints.budget_confirmed ? 
                        briefingData.constraints.budget_confirmed.range : null,
                    proposal_deadline: briefingData.constraints.proposal_deadline,
                    lead_time_business_days_after_valid_brief: 10,
                    do_not: briefingData.constraints.do_not || null,
                    prefer: briefingData.constraints.prefer || null
                },
                creative: {
                    sports_focus: briefingData.brief.sports_focus || briefingData.creative?.sports_focus || null,
                    audience_activity_min_sessions_per_week: briefingData.creative?.audience_activity_min_sessions_per_week || null
                }
            };
        }

        window.exportData = exportData;
        window.handleRetry = handleRetry;

        // Enhanced test function (already defined globally above)
        // This version adds more detailed diagnostics after dashboard initialization

        // Add global error handler
        window.addEventListener('error', function(event) {
            console.error('🔥 Global Error:', {
                message: event.message,
                source: event.filename,
                line: event.lineno,
                column: event.colno,
                error: event.error
            });
        });

        // Add unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('🔥 Unhandled Promise Rejection:', event.reason);
        });

        console.log('✅ Dashboard Ready!');

        // Add simple file handler immediately
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    console.log('File change event triggered:', file);
                    if (file && file.type === 'application/pdf') {
                        console.log('✅ PDF selected:', file.name, file.size, 'bytes');
                        console.log('🔍 Checking processFile function:', typeof window.processFile);
                        
                        if (typeof window.processFile === 'function') {
                            console.log('🚀 Starting processFile...');
                            try {
                                window.processFile(file);
                            } catch (error) {
                                console.error('❌ Error in processFile:', error);
                                alert('Error processing file: ' + error.message);
                            }
                        } else {
                            console.error('❌ processFile function not available');
                            alert('File selected: ' + file.name + ' - Processing function not available. Check console.');
                        }
                    } else if (file) {
                        console.log('❌ Invalid file type:', file.type);
                        alert('Please select a PDF file. You selected: ' + file.type);
                    } else {
                        console.log('❌ No file selected');
                    }
                });
            }
        });
    </script>
</body>
</html>