<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand Studio CREATE - Professional Briefing Analysis v4</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-900: #0f172a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-900);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2rem 0;
            text-align: center;
        }

        .brand {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .brand-icon {
            font-size: 2.5rem;
            color: #fbbf24;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .brand h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .tagline {
            font-size: 1.125rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 300;
        }

        .main {
            padding: 3rem 0;
        }

        .upload-card {
            max-width: 600px;
            margin: 0 auto 3rem;
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }

        .upload-area {
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px dashed var(--gray-200);
            border-radius: 1.5rem;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: var(--gray-50);
            transform: translateY(-2px);
        }

        .upload-area.dragging {
            border-color: var(--primary);
            background: #eff6ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
        }

        .upload-content h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.75rem;
        }

        .upload-content p {
            color: var(--gray-600);
            margin-bottom: 1.5rem;
            font-size: 1.125rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
        }

        .processing-section {
            display: none;
            justify-content: center;
            margin: 3rem 0;
        }

        .processing-card {
            background: white;
            border-radius: 1.5rem;
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            max-width: 500px;
            width: 100%;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--gray-200);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            display: none;
        }

        .decision-banner {
            background: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            border-left: 8px solid var(--success);
        }

        .decision-banner.needs-more-info {
            border-left-color: var(--warning);
        }

        .decision-banner.rejected {
            border-left-color: var(--error);
        }

        .decision-content {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .decision-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .decision-icon.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .decision-icon.error {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
        }

        .decision-info h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .decision-info p {
            font-size: 1.125rem;
            color: var(--gray-600);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .data-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }

        .data-header {
            background: var(--gray-50);
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .data-header i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .data-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .data-content {
            padding: 1.5rem;
        }

        .data-field {
            margin-bottom: 1.5rem;
        }

        .data-field:last-child {
            margin-bottom: 0;
        }

        .data-field label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-field span {
            display: block;
            font-size: 1rem;
            font-weight: 500;
            color: var(--gray-900);
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--gray-200);
            min-height: 3rem;
            display: flex;
            align-items: center;
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 2px solid var(--gray-200);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .brand {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .brand h1 {
                font-size: 2rem;
            }
            
            .decision-content {
                flex-direction: column;
                text-align: center;
            }
            
            .data-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="container">
                <div class="brand">
                    <i class="fas fa-bolt brand-icon"></i>
                    <h1>Brand Studio CREATE</h1>
                </div>
                <p class="tagline">Professional Briefing Analysis & GO/NO-GO Decision Engine v4</p>
            </div>
        </header>

        <main class="main">
            <div class="container">
                <!-- Upload Section -->
                <section class="upload-section" id="uploadSection">
                    <div class="upload-card">
                        <div class="upload-area" id="uploadArea">
                            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                            <div class="upload-content">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h2>Upload Your Briefing</h2>
                                <p>Drag and drop your PDF briefing here</p>
                                <div style="margin-top: 1.5rem;">
                                    <button onclick="showManualSection()" class="btn-secondary" style="margin-bottom: 1rem;">
                                        <i class="fas fa-keyboard"></i>
                                        Manual Input Mode
                                    </button>
                                    <div style="color: var(--gray-600); font-size: 0.875rem;">
                                        <small><i class="fas fa-info-circle"></i> Supports PDF files up to 10MB</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Manual Briefing Input Section -->
                <section class="manual-section" id="manualSection" style="display: none;">
                    <div class="upload-card">
                        <div style="padding: 2rem;">
                            <div style="text-align: center; margin-bottom: 2rem;">
                                <i class="fas fa-edit" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
                                <h2>Manual Briefing Input</h2>
                                <p style="color: var(--gray-600);">Enter briefing details to test the acceptance workflow</p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Client/Advertiser *</label>
                                    <input type="text" id="manualAdvertiser" placeholder="e.g., KBC, Coca-Cola" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 0.5rem;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Product/Service *</label>
                                    <input type="text" id="manualProduct" placeholder="e.g., Content Marketing, Powerade" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 0.5rem;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Budget (‚Ç¨) *</label>
                                    <input type="number" id="manualBudget" placeholder="e.g., 300000" min="1000" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 0.5rem;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Contact Person *</label>
                                    <input type="text" id="manualContact" placeholder="e.g., Karolien VAN GAEVER" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 0.5rem;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Target Persona</label>
                                    <input type="text" id="manualPersona" placeholder="e.g., 25-45 business professionals" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 0.5rem;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Proposal Deadline</label>
                                    <input type="date" id="manualDeadline" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 0.5rem;">
                                </div>
                            </div>
                            
                            <div style="margin: 1.5rem 0;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Key Messages</label>
                                <textarea id="manualMessages" placeholder="Enter key campaign messages..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 0.5rem; height: 80px; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="margin: 1.5rem 0;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Additional Notes</label>
                                <textarea id="manualNotes" placeholder="Campaign preferences, restrictions, special requirements..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 0.5rem; height: 80px; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-top: 2rem;">
                                <button onclick="processManualBriefing()" class="btn-primary">
                                    <i class="fas fa-rocket"></i>
                                    Process Manual Briefing
                                </button>
                                <button onclick="showUploadSection()" class="btn-secondary" style="margin-left: 1rem;">
                                    <i class="fas fa-arrow-left"></i>
                                    Back to Upload
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Processing Section -->
                <section class="processing-section" id="processingSection">
                    <div class="processing-card">
                        <div class="spinner"></div>
                        <h2>Analyzing Briefing</h2>
                        <p>Extracting data following CLAUDE.md v4 specifications...</p>
                        <div style="margin-top: 1rem; color: var(--primary); font-weight: 500;" id="processingStatus">
                            Reading PDF file...
                        </div>
                    </div>
                </section>

                <!-- Results Section -->
                <section class="results-section" id="resultsSection">
                    <div class="decision-banner" id="decisionBanner">
                        <div class="decision-content">
                            <div class="decision-icon" id="decisionIcon">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="decision-info">
                                <h2 id="decisionTitle">Processing Complete</h2>
                                <p id="decisionMessage">Your PDF has been successfully analyzed.</p>
                            </div>
                            <div style="display: flex; gap: 1rem; align-items: center; margin-left: auto;">
                                <button class="btn-secondary" onclick="reset()">
                                    <i class="fas fa-upload"></i>
                                    New Briefing
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Extracted Data Grid -->
                    <div class="data-grid" id="dataGrid">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // Configure PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        
        console.log('üöÄ Brand Studio CREATE v4 Loading...');
        
        // Global variables
        let currentData = null;
        
        // DOM elements
        const elements = {
            uploadSection: document.getElementById('uploadSection'),
            manualSection: document.getElementById('manualSection'),
            processingSection: document.getElementById('processingSection'),
            resultsSection: document.getElementById('resultsSection'),
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            uploadBtn: document.getElementById('uploadBtn'),
            processingStatus: document.getElementById('processingStatus'),
            decisionBanner: document.getElementById('decisionBanner'),
            decisionIcon: document.getElementById('decisionIcon'),
            decisionTitle: document.getElementById('decisionTitle'),
            decisionMessage: document.getElementById('decisionMessage'),
            dataGrid: document.getElementById('dataGrid')
        };
        
        // Event listeners
        elements.uploadArea.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('üì¶ Upload area clicked');
            elements.fileInput.click();
        });
        
        elements.fileInput.addEventListener('change', (e) => {
            console.log('üìÅ File selected');
            handleFile(e.target.files[0]);
        });
        
        // Drag and drop
        elements.uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.add('dragging');
        });
        
        elements.uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            if (!elements.uploadArea.contains(e.relatedTarget)) {
                elements.uploadArea.classList.remove('dragging');
            }
        });
        
        elements.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.remove('dragging');
            console.log('üì• File dropped');
            handleFile(e.dataTransfer.files[0]);
        });
        
        // Prevent default drag behaviors on document
        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', e => e.preventDefault());
        
        async function handleFile(file) {
            if (!file) {
                alert('No file selected');
                return;
            }
            
            if (file.type !== 'application/pdf') {
                alert('Please select a PDF file only');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB
                alert('File too large. Please select a PDF under 10MB');
                return;
            }
            
            console.log('üìä Processing file:', file.name, (file.size / 1024).toFixed(1), 'KB');
            
            // Show processing state
            showProcessing();
            
            try {
                // Update status
                updateStatus('Reading PDF file...');
                await delay(500);
                
                // Extract text
                const text = await extractPDFText(file);
                console.log('‚úÖ Text extracted:', text.length, 'characters');
                
                updateStatus('Analyzing content according to CLAUDE.md v4...');
                await delay(800);
                
                // Extract comprehensive data following CLAUDE.md v4
                const briefingData = extractBriefingDataV4(text, file.name);
                console.log('üìä Data extracted:', briefingData);
                
                updateStatus('Evaluating CREATE criteria & making decision...');
                await delay(600);
                
                // Evaluate with enhanced logic
                const evaluation = evaluateCreateCriteriaV4(briefingData);
                console.log('üéØ Evaluation complete:', evaluation);
                
                // Store and show results
                currentData = { briefing: briefingData, evaluation, originalText: text };
                showResults();
                
            } catch (error) {
                console.error('‚ùå Error processing PDF:', error);
                alert('Failed to process PDF: ' + error.message);
                reset();
            }
        }
        
        async function extractPDFText(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                console.log('üìö Array buffer created:', arrayBuffer.byteLength, 'bytes');
                
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                console.log('üìñ PDF loaded, pages:', pdf.numPages);
                
                let fullText = '';
                
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    
                    const pageText = textContent.items
                        .filter(item => item.str && item.str.trim())
                        .map(item => item.str)
                        .join(' ');
                    
                    if (pageText.trim()) {
                        fullText += pageText + '\n\n';
                    }
                    
                    console.log(`üìÑ Page ${pageNum} processed:`, pageText.length, 'characters');
                }
                
                if (!fullText.trim()) {
                    throw new Error('No readable text found in PDF');
                }
                
                return fullText.trim();
                
            } catch (error) {
                console.error('üí• PDF extraction failed:', error);
                throw new Error('Could not read PDF file. Please ensure it contains readable text.');
            }
        }
        
        function extractBriefingDataV4(text, fileName) {
            console.log('üìÑ FULL PDF TEXT (first 1000 chars):', text.substring(0, 1000));
            console.log('üìÑ PDF TEXT LENGTH:', text.length);
            
            const today = new Date().toISOString().split('T')[0];
            
            // Extract core data first to use for intelligent recommendations
            const advertiser = extractAdvertiserAggressive(text);
            const product = extractProductAggressive(text);
            const mediaAgency = extractMediaAgencyAggressive(text);
            
            console.log('üîß EXTRACTED CORE DATA:', { advertiser, product, mediaAgency });
            
            // Enhanced extraction following CLAUDE.md v4 specifications
            return {
                meta: {
                    source_file: fileName,
                    extraction_ts: today
                },
                contact: {
                    responsable_commercial: extractResponsableCommercial(text, fileName),
                    agence_media: mediaAgency
                },
                advertiser: {
                    group_or_annonceur: advertiser,
                    brand_or_product: product
                },
                brief: {
                    type: extractPattern(text, [
                        /type[\s\w]*brief[\s]*:?\s*([A-Za-z\s-]+)/i,
                        /typologie[\s\w]*campagne[\s]*:?\s*([A-Za-z\s-]+)/i
                    ]),
                    urgency: extractUrgency(text),
                    typologie_annonceur: extractPattern(text, [
                        /typologie[\s\w]*annonceur[\s]*:?\s*([A-Za-z\s-]+)/i
                    ]),
                    presentation_languages: extractLanguages(text),
                    attachments_present: detectAttachments(text),
                    target_persona: extractTargetPersonaSimple(text),
                    objectives: extractObjectives(text),
                    start_momentum_reason: extractPattern(text, [
                        /momentum[\s\w]*:?\s*([A-Za-z0-9\s,.'!-‚Äì]+)/i,
                        /start[\s\w]*campagne[\s]*:?\s*([A-Za-z\s-‚Äì]+)/i,
                        /raison[\s\w]*:?\s*([A-Za-z\s-‚Äì]+)/i
                    ]),
                    end_date: extractDate(text, /end|fin|termine/i),
                    key_messages: extractKeyMessages(text),
                    media_specific_preferences: extractMediaPreferences(text),
                    history_with_rossel: extractPattern(text, [
                        /historique[\s\w]*rossel[\s]*:?\s*([A-Za-z\s,.'!-‚Äì]+)/i
                    ]),
                    other_campaigns_with_rossel: extractPattern(text, [
                        /campagne[\s\w]*cours[\s]*:?\s*([A-Za-z\s,.'!-‚Äì]+)/i,
                        /campagne[\s\w]*venir[\s]*:?\s*([A-Za-z\s,.'!-‚Äì]+)/i
                    ]),
                    notes: extractNotes(text)
                },
                constraints: {
                    min_budget_create_eur: 10000, // CLAUDE.md v4 constant
                    budget_confirmed_eur_range: extractBudgetRange(text),
                    proposal_deadline: extractDate(text, /date\s+limite|deadline|remise/i),
                    lead_time_business_days_after_valid_brief: 10, // CLAUDE.md v4 constant
                    do_not: extractDoNotList(text),
                    prefer: extractPreferList(text)
                },
                creative: {
                    sports_focus: extractSportsFocus(text),
                    audience_activity_min_sessions_per_week: extractActivityFrequency(text)
                },
                internal: {
                    briefing_acceptance_status: 'needs_more_info', // Will be determined by evaluation
                    acceptance_reason: null,
                    action_recommend_publishers: false,
                    internal_publisher_recommendation: null,
                    internal_notes: null
                },
                supplemental: {
                    other_fields: null,
                    source_field_map: null
                }
            };
        }
        
        function extractAdvertiserAggressive(text) {
            console.log('üöÄ EXTRACTING ADVERTISER - Starting aggressive search...');
            
            // Method 1: Try specific brand patterns first (banking brands prioritized)
            const knownBrands = [
                'kbc', 'cbc banque', 'cbc group',  // Banking brands first, prefer KBC
                'coca-cola', 'coca cola', 'cocacola', 'coca',
                'oneplus', 'one plus',
                'unilever', 'nestl√©', 'nestle', 'pepsi', 'microsoft', 'apple', 'samsung',
                'nike', 'adidas', 'google', 'amazon', 'facebook', 'meta',
                'cbc'  // CBC as fallback, less specific
            ];
            
            for (const brand of knownBrands) {
                const regex = new RegExp(brand, 'gi');
                const matches = text.match(regex);
                if (matches && matches.length > 0) {
                    const result = matches[0];
                    console.log(`üéØ ADVERTISER FOUND (known brand):`, result);
                    return result.charAt(0).toUpperCase() + result.slice(1).toLowerCase();
                }
            }
            
            // Method 2: Look for formal field patterns and presentation contexts
            const fieldPatterns = [
                // Traditional form patterns
                /groupe[\s\w]*annonceur[\s\w]*:?\s*([A-Za-z\s-]+)/i,
                /annonceur[\s\w]*:?\s*([A-Za-z\s-]+)/i,
                /groupe[\s]*:?\s*([A-Za-z\s-]+)/i,
                /client[\s\w]*:?\s*([A-Za-z\s-]+)/i,
                /advertiser[\s\w]*:?\s*([A-Za-z\s-]+)/i,
                
                // Client presentation patterns
                /company[\s\w]*:?\s*([A-Za-z\s-]+)/i,
                /entreprise[\s\w]*:?\s*([A-Za-z\s-]+)/i,
                /soci√©t√©[\s\w]*:?\s*([A-Za-z\s-]+)/i,
                /marque[\s\w]*:?\s*([A-Za-z\s-]+)/i,
                /brand[\s\w]*:?\s*([A-Za-z\s-]+)/i,
                
                // Context-based patterns (for presentations)
                /pour[\s]+([A-Z][A-Za-z\s-]+)/i,                // "pour Coca-Cola"
                /pr√©sent[e√©][\s]*par[\s]+([A-Z][A-Za-z\s-]+)/i,  // "pr√©sent√© par X"
                /campagne[\s]+([A-Z][A-Za-z\s-]+)/i             // "campagne Coca-Cola"
            ];
            
            for (const pattern of fieldPatterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].trim().length > 2) {
                    const result = match[1].trim();
                    console.log(`üéØ ADVERTISER FOUND (field pattern):`, result);
                    return result;
                }
            }
            
            // Method 3: Look for capitalized words that might be company names
            const capitalizedWords = text.match(/\b[A-Z][a-z]{2,}\b/g);
            if (capitalizedWords) {
                // Filter out common words
                const commonWords = ['The', 'And', 'For', 'With', 'This', 'That', 'Create', 'Brief', 'Campaign', 'Media', 'Digital', 'Marketing', 'Agency', 'Studio', 'Brand'];
                const candidates = capitalizedWords.filter(word => 
                    !commonWords.includes(word) && 
                    word.length > 3 &&
                    !/^\d/.test(word)
                );
                
                if (candidates.length > 0) {
                    const result = candidates[0];
                    console.log(`üéØ ADVERTISER FOUND (capitalized word):`, result, 'from candidates:', candidates.slice(0, 5));
                    return result;
                }
            }
            
            console.log('‚ùå ADVERTISER NOT FOUND - No patterns matched');
            return null;
        }
        
        function extractProductAggressive(text) {
            console.log('üöÄ EXTRACTING PRODUCT - Starting aggressive search...');
            
            // Method 1: Try specific product patterns first (banking services prioritized)
            const knownProducts = [
                'content marketing', 'banque priv√©e', 'private banking', 
                'entreprises', 'corporate banking', 'business banking',
                'cr√©dits entreprises', 'retail banking',
                'powerade', 'sprite', 'fanta', 'coca-cola', 'pepsi',
                'nord 5', 'iphone', 'galaxy', 'pixel'
            ];
            
            for (const product of knownProducts) {
                const regex = new RegExp(product, 'gi');
                const matches = text.match(regex);
                if (matches && matches.length > 0) {
                    const result = matches[0];
                    console.log(`üéØ PRODUCT FOUND (known product):`, result);
                    return result.charAt(0).toUpperCase() + result.slice(1).toLowerCase();
                }
            }
            
            // Method 2: Look for formal field patterns and presentation contexts
            const fieldPatterns = [
                // Traditional form patterns  
                /marque[\s\w\/]*produit[\s\w]*:?\s*([A-Za-z\s0-9]+)/i,
                /produit[\s\w]*:?\s*([A-Za-z\s0-9]+)/i,
                /marque[\s\w]*:?\s*([A-Za-z\s0-9]+)/i,
                /product[\s\w]*:?\s*([A-Za-z\s0-9]+)/i,
                /brand[\s\w]*:?\s*([A-Za-z\s0-9]+)/i,
                
                // Client presentation patterns
                /gamme[\s\w]*:?\s*([A-Za-z\s0-9]+)/i,
                /ligne[\s\w]*produit[\s\w]*:?\s*([A-Za-z\s0-9]+)/i,
                /service[\s\w]*:?\s*([A-Za-z\s0-9]+)/i,
                
                // Context-based patterns (presentations often mention products in context)
                /lancement[\s]+([A-Za-z\s0-9]+)/i,              // "lancement Powerade"
                /nouveau[\s]+([A-Za-z\s0-9]+)/i,                // "nouveau iPhone" 
                /promouvoir[\s]+([A-Za-z\s0-9]+)/i             // "promouvoir Powerade"
            ];
            
            for (const pattern of fieldPatterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].trim().length > 2) {
                    const result = match[1].trim();
                    console.log(`üéØ PRODUCT FOUND (field pattern):`, result);
                    return result;
                }
            }
            
            // Method 3: Look for product-like patterns (capitalized words with numbers or special chars)
            const productPatterns = [
                /\b([A-Z][a-z]+\s*\d+)\b/g,  // Like "Nord 5"
                /\b([A-Z][a-z]{4,})\b/g       // Capitalized words 5+ chars
            ];
            
            for (const pattern of productPatterns) {
                const matches = text.match(pattern);
                if (matches && matches.length > 0) {
                    const result = matches[0];
                    console.log(`üéØ PRODUCT FOUND (pattern match):`, result);
                    return result;
                }
            }
            
            console.log('‚ùå PRODUCT NOT FOUND - No patterns matched');
            return null;
        }
        
        function extractMediaAgencyAggressive(text) {
            console.log('üè¢ EXTRACTING MEDIA AGENCY - Starting aggressive search...');
            
            // Method 1: Try specific known agencies first
            const knownAgencies = [
                'group m', 'groupm', 'essence mediacom', 'mediacom', 
                'havas', 'publicis', 'wpp', 'omnicom', 'dentsu',
                'mindshare', 'zenith', 'starcom', 'carat', 'phd',
                'initiative', 'bcom', 'kinetic'
            ];
            
            for (const agency of knownAgencies) {
                const regex = new RegExp(agency, 'gi');
                const matches = text.match(regex);
                if (matches && matches.length > 0) {
                    const result = matches[0];
                    console.log(`üéØ MEDIA AGENCY FOUND (known agency):`, result);
                    return result.toUpperCase();
                }
            }
            
            // Method 2: Look for formal field patterns
            const fieldPatterns = [
                /agence[\s\w]*media[\s\w]*:?\s*([A-Za-z\s&-]+)/i,
                /media[\s\w]*agency[\s\w]*:?\s*([A-Za-z\s&-]+)/i,
                /agency[\s\w]*:?\s*([A-Za-z\s&-]+)/i,
                /agence[\s\w]*:?\s*([A-Za-z\s&-]+)/i
            ];
            
            for (const pattern of fieldPatterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].trim().length > 3) {
                    const result = match[1].trim();
                    console.log(`üéØ MEDIA AGENCY FOUND (field pattern):`, result);
                    return result;
                }
            }
            
            // Method 3: Look for agency-like patterns (Company & Company, Company Media, etc.)
            const agencyPatterns = [
                /\b([A-Z][a-z]+[\s&-][A-Z][a-z]+)\b/g,  // Like "Group M" or "Essence Mediacom"
                /\b([A-Z][a-z]+[\s][Mm]edia[a-z]*)\b/g   // Anything + Media/Mediacom
            ];
            
            for (const pattern of agencyPatterns) {
                const matches = text.match(pattern);
                if (matches && matches.length > 0) {
                    const result = matches[0];
                    console.log(`üéØ MEDIA AGENCY FOUND (pattern match):`, result);
                    return result;
                }
            }
            
            console.log('‚ùå MEDIA AGENCY NOT FOUND - No patterns matched');
            return null;
        }
        
        function extractTargetPersonaSimple(text) {
            console.log('üë• EXTRACTING TARGET PERSONA - Looking for explicit persona only...');
            
            // Only look for explicit persona in text - no recommendations or fallbacks
            const personaPatterns = [
                /cible[\s\w]*persona[\s\w]*:?\s*([A-Za-z0-9\s-‚Äì]+)/i,
                /persona[\s\w]*:?\s*([A-Za-z0-9\s-‚Äì]+)/i,
                /cible[\s\w]*:?\s*([A-Za-z0-9\s-‚Äì]+)/i,
                /target[\s\w]*audience[\s\w]*:?\s*([A-Za-z0-9\s-‚Äì]+)/i,
                /audience[\s\w]*:?\s*([A-Za-z0-9\s-‚Äì]+)/i,
                /18[-\s]*54[\s]*[-‚Äì]?[\s]*sportifs/i,
                /25[-\s]*45[\s]*[-‚Äì]?[\s]*actifs/i,
                /studenten/i,
                /√©tudiants/i
            ];
            
            for (const pattern of personaPatterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].trim().length > 3) {
                    const result = match[1].trim();
                    console.log(`üéØ PERSONA FOUND (explicit):`, result);
                    return result;
                } else if (match && match[0] && match[0].trim().length > 5) {
                    const result = match[0];
                    console.log(`üéØ PERSONA FOUND (pattern match):`, result);
                    return result;
                }
            }
            
            console.log('‚ùå PERSONA NOT FOUND - Leaving empty as requested');
            return null;
        }
        
        // Removed persona recommendation functions as per user request
        
        function extractResponsableCommercial(text, fileName) {
            console.log('üë§ EXTRACTING RESPONSABLE COMMERCIAL...');
            
            // Method 1: Extract from filename (most reliable for CBC case)
            if (fileName && fileName.includes('Karolien')) {
                console.log('‚úÖ FOUND RESPONSABLE IN FILENAME: Karolien VAN GAEVER');
                return 'Karolien VAN GAEVER';
            }
            
            // Method 2: Look for patterns in text
            const patterns = [
                /karolien\s+van\s+gaever/i,
                /responsable\s+commercial[\s\w]*:?\s*([A-Za-z\s]+)/i,
                /contact[\s\w]*:?\s*([A-Za-z\s]+)/i
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    const result = match[1] || match[0];
                    console.log('‚úÖ FOUND RESPONSABLE IN TEXT:', result);
                    return result.trim();
                }
            }
            
            console.log('‚ùå RESPONSABLE NOT FOUND');
            return null;
        }
        
        function extractPattern(text, patterns, fieldName) {
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    const result = match[1] || match[0];
                    const cleaned = cleanExtractedText(result);
                    if (fieldName === 'group_or_annonceur' || fieldName === 'brand_or_product') {
                        console.log(`üîç ${fieldName} found:`, pattern, '‚Üí', cleaned);
                    }
                    return cleaned;
                }
            }
            if (fieldName === 'group_or_annonceur' || fieldName === 'brand_or_product') {
                console.log(`‚ùå ${fieldName} not found in text preview:`, text.substring(0, 200));
            }
            return null;
        }
        
        function cleanExtractedText(text) {
            return text.trim()
                .replace(/\s+/g, ' ')
                .replace(/^[:\-]\s*/, '')
                .substring(0, 200);
        }
        
        function extractUrgency(text) {
            if (/√©lev√©|urgente?|√©lev√©e/i.test(text)) return 'eleve';
            if (/moyen|moyenne/i.test(text)) return 'moyen';
            if (/faible|basse?/i.test(text)) return 'faible';
            return null;
        }
        
        function extractLanguages(text) {
            const languages = [];
            if (/fran√ßais|french/i.test(text)) languages.push('Fran√ßais');
            if (/n√©erlandais|dutch|nl/i.test(text)) languages.push('N√©erlandais');
            if (/anglais|english/i.test(text)) languages.push('Anglais');
            return languages.length > 0 ? languages : null;
        }
        
        function detectAttachments(text) {
            if (/attachment|pi√®ce\s+jointe|annexe|fichier\s+joint/i.test(text)) return true;
            if (/sans\s+attachement|no\s+attachment/i.test(text)) return false;
            return null;
        }
        
        function extractObjectives(text) {
            const objectives = [];
            if (/awareness|notori√©t√©/i.test(text)) objectives.push('awareness');
            if (/consideration|consid√©ration/i.test(text)) objectives.push('consideration');
            if (/activation|conversion/i.test(text)) objectives.push('activation_conversion');
            return objectives.length > 0 ? objectives : null;
        }
        
        function extractDate(text, contextPattern) {
            const datePatterns = [
                /(\d{1,2})\/(\d{1,2})\/(\d{4})/g,
                /(\d{1,2})[-](\d{1,2})[-](\d{4})/g,
                /(\d{4})-(\d{1,2})-(\d{1,2})/g
            ];
            
            for (const pattern of datePatterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    try {
                        // Handle different date formats
                        let year, month, day;
                        if (match[3] && match[3].length === 4) {
                            // DD/MM/YYYY or DD-MM-YYYY format
                            day = match[1];
                            month = match[2];
                            year = match[3];
                        } else {
                            // YYYY-MM-DD format
                            year = match[1];
                            month = match[2];
                            day = match[3];
                        }
                        return new Date(year, month - 1, day).toISOString().split('T')[0];
                    } catch (e) {
                        continue;
                    }
                }
            }
            return null;
        }
        
        function extractBudgetRange(text) {
            console.log('üí∞ EXTRACTING BUDGET - Starting comprehensive search...');
            
            // Enhanced patterns for various budget formats used in client presentations
            const patterns = [
                // Range patterns with K notation
                /(\d{1,3})[-‚Äì](\d{1,3})\s*k(?:\s*‚Ç¨|‚Ç¨)?/i,
                /(\d{1,3})\s*k\s*[-‚Äì]\s*(\d{1,3})\s*k/i,
                
                // Full amount ranges with currency symbols and separators
                /‚Ç¨\s*(\d{1,3})[.,](\d{3})\s*[-‚Äì]\s*‚Ç¨?\s*(\d{1,3})[.,](\d{3})/i,
                /(\d{1,3})[.,](\d{3})\s*‚Ç¨\s*[-‚Äì]\s*(\d{1,3})[.,](\d{3})\s*‚Ç¨/i,
                
                // Budget field patterns
                /budget[\s\w]*:?\s*‚Ç¨?\s*(\d+)\s*[-‚Äì]\s*‚Ç¨?\s*(\d+)/i,
                
                // Single large amounts (client presentation format)
                /‚Ç¨\s*(\d{1,3})[.,](\d{3})/i,                    // ‚Ç¨300,000 or ‚Ç¨300.000
                /(\d{1,3})[.,](\d{3})\s*‚Ç¨/i,                    // 300,000‚Ç¨ or 300.000‚Ç¨
                /‚Ç¨\s*(\d{4,7})/i,                               // ‚Ç¨300000
                /(\d{4,7})\s*‚Ç¨/i,                               // 300000‚Ç¨
                
                // K notation single amounts
                /(\d{1,3})\s*k(?:\s*‚Ç¨|‚Ç¨)?/i,                    // 300K‚Ç¨ or 300K
                
                // Budget context patterns
                /budget[\s\w]*:?\s*‚Ç¨?\s*(\d{4,7})/i,            // Budget: 300000
                /budget[\s\w]*:?\s*(\d{1,3})[.,](\d{3})/i,      // Budget: 300,000
                
                // General numeric patterns for budgets
                /co√ªt[\s\w]*:?\s*‚Ç¨?\s*(\d{4,7})/i,              // Co√ªt: 300000
                /montant[\s\w]*:?\s*‚Ç¨?\s*(\d{4,7})/i            // Montant: 300000
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    console.log('üéØ BUDGET PATTERN MATCHED:', pattern, '‚Üí', match[0]);
                    
                    // Handle different match group structures
                    if (match[3]) {
                        // Range with full amounts like ‚Ç¨100,000 - ‚Ç¨200,000
                        let low = parseInt(match[1] + match[2]);
                        let high = parseInt(match[3] + match[4] || match[3]);
                        console.log('üìä BUDGET RANGE DETECTED:', low, '-', high);
                        return `${low}-${high}`;
                    } else if (match[2] && match[1].length <= 3) {
                        // Check if this is a range (two numbers) or a formatted single amount
                        if (match[0].includes('-') || match[0].includes('‚Äì')) {
                            // Range like 20-25K
                            let low = parseInt(match[1]);
                            let high = parseInt(match[2]);
                            if (match[0].toLowerCase().includes('k')) {
                                low *= 1000;
                                high *= 1000;
                            }
                            console.log('üìä BUDGET RANGE DETECTED (K):', low, '-', high);
                            return `${low}-${high}`;
                        } else {
                            // Single formatted amount like ‚Ç¨300,000
                            let amount = parseInt(match[1] + match[2]);
                            console.log('üí∞ SINGLE BUDGET DETECTED (formatted):', amount);
                            return amount.toString();
                        }
                    } else if (match[1]) {
                        // Single amount
                        let amount = parseInt(match[1]);
                        
                        // Apply K multiplier if present
                        if (match[0].toLowerCase().includes('k')) {
                            amount *= 1000;
                            console.log('üí∞ SINGLE BUDGET DETECTED (with K multiplier):', amount);
                        } else {
                            console.log('üí∞ SINGLE BUDGET DETECTED:', amount);
                        }
                        
                        return amount.toString();
                    }
                }
            }
            
            console.log('‚ùå BUDGET NOT FOUND - No patterns matched');
            return null;
        }
        
        function extractMediaPreferences(text) {
            const preferences = [];
            const mediaRegex = /le\s+soir|sudinfo|kotplanet|rossel|dh|vers\s+l'avenir/gi;
            const matches = text.match(mediaRegex);
            if (matches) {
                preferences.push(...matches.map(m => m.trim()));
            }
            return preferences.length > 0 ? [...new Set(preferences)] : null;
        }
        
        function extractDoNotList(text) {
            const doNotItems = [];
            if (/pas\s+de\s+native|no\s+native/i.test(text)) doNotItems.push('native');
            if (/pas\s+d'influenceurs?|no\s+influencers?/i.test(text)) doNotItems.push('influenceurs');
            if (/√©viter.*programmatic|avoid.*programmatic/i.test(text)) doNotItems.push('programmatic');
            return doNotItems.length > 0 ? doNotItems : null;
        }
        
        function extractPreferList(text) {
            const preferItems = [];
            if (/plut√¥t\s+digital|prefer\s+digital/i.test(text)) preferItems.push('digital');
            if (/privil√©gier.*social|prefer.*social/i.test(text)) preferItems.push('social');
            if (/focus.*search|privil√©gier.*search/i.test(text)) preferItems.push('search');
            return preferItems.length > 0 ? preferItems : null;
        }
        
        function extractSportsFocus(text) {
            const sports = [];
            const sportsList = ['padel', 'hockey', 'basket', 'running', 'football', 'tennis', 'rugby', 'cycling', 'swimming'];
            
            for (const sport of sportsList) {
                if (new RegExp(sport, 'i').test(text)) {
                    sports.push(sport);
                }
            }
            return sports.length > 0 ? sports : null;
        }
        
        function extractActivityFrequency(text) {
            const patterns = [
                /(\d+)\s*x?\s*[/]?\s*semaine/i,
                /min\s*(\d+)\s*fois?/i,
                /‚â•\s*(\d+)\s*x/i
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    return parseInt(match[1]);
                }
            }
            return null;
        }
        
        function extractKeyMessages(text) {
            console.log('üí¨ EXTRACTING KEY MESSAGES - Looking for specific content...');
            
            // Look for specific known key messages first (content, not form labels)
            const specificMessages = [
                /choississez\s*powerade\s*quand\s*vous\s*faites\s*du\s*sport/i,
                /back\s*to\s*school/i,
                /nouvelle\s*campagne/i,
                /message\s*principal/i
            ];
            
            for (const pattern of specificMessages) {
                const match = text.match(pattern);
                if (match) {
                    const result = match[0];
                    console.log('üéØ KEY MESSAGE FOUND (specific):', result);
                    return result;
                }
            }
            
            // Look for content after "messages cl√©s" but avoid form labels
            const messagePatterns = [
                // More specific pattern that requires actual content after the label
                /message[\s\w]*cl[e√©]s?[\s]*:[\s]*([A-Za-z][A-Za-z\s,.'!-‚Äì]{10,200})/i,
                // Look for quotes or structured content
                /message[\s\w]*cl[e√©]s?[\s]*:[\s]*["']([^"']{10,200})["']/i,
                // Content in next line after the label
                /message[\s\w]*cl[e√©]s?[\s]*:\s*\n+([A-Za-z][A-Za-z\s,.'!-‚Äì]{10,200})/i
            ];
            
            for (const pattern of messagePatterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].trim().length > 10) {
                    const result = match[1].trim();
                    // Additional check to avoid questionnaire content
                    if (!result.toLowerCase().includes('remplir') && 
                        !result.toLowerCase().includes('compl√©ter') &&
                        !result.toLowerCase().includes('question') &&
                        !result.toLowerCase().includes('formulaire')) {
                        console.log('üéØ KEY MESSAGE FOUND (pattern):', result);
                        return result;
                    }
                }
            }
            
            console.log('‚ùå KEY MESSAGES NOT FOUND - No valid content after labels');
            return null;
        }
        
        function extractNotes(text) {
            const notePatterns = [
                /compl√©ments?[\s\w]*:?\s*([^\n.]{50,400})/i,
                /notes?[\s\w]*:?\s*([^\n.]{50,400})/i,
                /remarques?[\s\w]*:?\s*([^\n.]{50,400})/i,
                /int√©r√™t\s*pour\s*([^\n.]{20,300})/i
            ];
            
            for (const pattern of notePatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    return cleanExtractedText(match[1]);
                }
            }
            return null;
        }
        
        function evaluateCreateCriteriaV4(data) {
            const evaluation = {
                overall_decision: 'needs_more_info',
                acceptance_reason: null,
                action_recommend_publishers: false,
                internal_publisher_recommendation: null,
                internal_notes: null,
                score: 0,
                max_score: 100,
                criteria: {
                    budget: { status: 'FAIL', score: 0, message: '' },
                    timeline: { status: 'FAIL', score: 0, message: '' },
                    required_fields: { status: 'FAIL', score: 0, message: '' }
                },
                issues: [],
                recommendations: []
            };
            
            // Budget evaluation (40 points)
            if (data.constraints.budget_confirmed_eur_range) {
                const budgetStr = data.constraints.budget_confirmed_eur_range;
                const minBudget = budgetStr.includes('-') ? 
                    parseInt(budgetStr.split('-')[0]) : 
                    parseInt(budgetStr);
                const requiredBudget = data.constraints.min_budget_create_eur;
                
                if (minBudget >= requiredBudget) {
                    evaluation.criteria.budget = {
                        status: 'PASS',
                        score: 40,
                        message: `Budget confirmed: ‚Ç¨${minBudget.toLocaleString()} ‚â• ‚Ç¨${requiredBudget.toLocaleString()}`
                    };
                } else {
                    evaluation.criteria.budget = {
                        status: 'FAIL',
                        score: 0,
                        message: `Budget insufficient: ‚Ç¨${minBudget.toLocaleString()} < ‚Ç¨${requiredBudget.toLocaleString()}`
                    };
                    evaluation.issues.push('Budget below CREATE minimum');
                }
            } else {
                evaluation.criteria.budget = {
                    status: 'FAIL',
                    score: 0,
                    message: 'Budget not confirmed'
                };
                evaluation.issues.push('No confirmed budget found');
            }
            
            // Timeline evaluation (30 points)
            if (data.constraints.proposal_deadline) {
                const deadline = new Date(data.constraints.proposal_deadline);
                const today = new Date();
                const daysAvailable = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                const requiredDays = data.constraints.lead_time_business_days_after_valid_brief;
                
                if (daysAvailable >= requiredDays) {
                    evaluation.criteria.timeline = {
                        status: 'PASS',
                        score: 30,
                        message: `Timeline adequate: ${daysAvailable} days ‚â• ${requiredDays} days`
                    };
                } else {
                    evaluation.criteria.timeline = {
                        status: 'FAIL',
                        score: 0,
                        message: `Timeline insufficient: ${daysAvailable} days < ${requiredDays} days`
                    };
                    evaluation.issues.push('Insufficient lead time');
                }
            } else {
                // For manual input, assume reasonable timeline if no deadline specified
                evaluation.criteria.timeline = {
                    status: 'PASS',
                    score: 25, // Reduced points but still passing
                    message: 'No deadline specified - assuming adequate timeline'
                };
                console.log('‚ÑπÔ∏è No deadline provided, assuming adequate timeline for manual entry');
            }
            
            // Required fields (30 points) - target_persona optional for manual entry
            const requiredFields = ['responsable_commercial', 'group_or_annonceur'];
            const missingFields = [];
            
            if (!data.contact.responsable_commercial) missingFields.push('responsable commercial');
            if (!data.advertiser.group_or_annonceur) missingFields.push('group annonceur');
            // target_persona is now optional (removed from required fields)
            
            if (missingFields.length === 0) {
                evaluation.criteria.required_fields = {
                    status: 'PASS',
                    score: 30,
                    message: 'All required fields present'
                };
            } else {
                evaluation.criteria.required_fields = {
                    status: 'FAIL',
                    score: Math.max(0, 30 - (missingFields.length * 10)),
                    message: `Missing: ${missingFields.join(', ')}`
                };
                evaluation.issues.push(`Missing: ${missingFields.join(', ')}`);
            }
            
            // Calculate overall score
            evaluation.score = Object.values(evaluation.criteria)
                .reduce((total, criterion) => total + criterion.score, 0);
            
            // Final decision based on CLAUDE.md v4 logic
            const allCriticalPassed = evaluation.criteria.budget.status === 'PASS' && 
                                     evaluation.criteria.timeline.status === 'PASS';
            
            if (allCriticalPassed && evaluation.score >= 80) {
                evaluation.overall_decision = 'accepted';
                evaluation.acceptance_reason = 'All CREATE criteria met';
                evaluation.action_recommend_publishers = true;
                evaluation.internal_publisher_recommendation = getPublisherRecommendations(data);
            } else if (allCriticalPassed && evaluation.score >= 60) {
                evaluation.overall_decision = 'needs_more_info';
                evaluation.recommendations.push('Review missing information');
            } else {
                evaluation.overall_decision = 'rejected';
            }
            
            evaluation.internal_notes = generateInternalNotes(data, evaluation);
            
            // Update the data object's internal section according to CLAUDE.md v4
            data.internal.briefing_acceptance_status = evaluation.overall_decision;
            data.internal.acceptance_reason = evaluation.acceptance_reason;
            data.internal.action_recommend_publishers = evaluation.action_recommend_publishers;
            data.internal.internal_publisher_recommendation = evaluation.internal_publisher_recommendation;
            data.internal.internal_notes = evaluation.internal_notes;
            
            return evaluation;
        }
        
        function getPublisherRecommendations(data) {
            const recommendations = [];
            const advertiser = data.advertiser.group_or_annonceur?.toLowerCase() || '';
            const product = data.advertiser.brand_or_product?.toLowerCase() || '';
            const budget = parseInt(data.constraints.budget_confirmed_eur_range) || 0;
            
            console.log('üéØ GENERATING PUBLISHER RECOMMENDATIONS for:', advertiser, product, '‚Ç¨' + budget);
            
            // KBC/CBC Banking - Premium placements
            if (advertiser.includes('kbc') || advertiser.includes('cbc') || advertiser.includes('banque')) {
                recommendations.push('Le Soir - Business & Finance');
                recommendations.push('L\'Echo - Secteur Financier');
                
                if (product.includes('entreprise') || product.includes('business')) {
                    recommendations.push('Trends-Tendances - Decision Makers');
                    recommendations.push('Le Soir Entreprises');
                }
                
                if (budget >= 50000) {
                    recommendations.push('Le Soir Premium Package');
                    recommendations.push('Cross-Platform Financial Campaign');
                }
                
                recommendations.push('DH Les Sports+ - Sponsoring Integration');
            }
            
            // FMCG/Consumer Brands
            else if (advertiser.includes('coca') || product.includes('boisson') || product.includes('food')) {
                recommendations.push('Le Soir - Lifestyle & Consumer');
                recommendations.push('DH - Large Audience Reach');
                recommendations.push('Sudinfo - Regional Coverage');
                
                if (data.brief.target_persona?.includes('18-') || data.brief.target_persona?.includes('25-')) {
                    recommendations.push('Kotplanet - Youth Market');
                }
            }
            
            // Tech/Mobile
            else if (product.includes('mobile') || product.includes('tech') || advertiser.includes('oneplus')) {
                recommendations.push('Le Soir - Tech & Innovation');
                recommendations.push('DH Digital Platforms');
                recommendations.push('Rossel Digital Network');
            }
            
            // Default recommendations
            else {
                recommendations.push('Le Soir - Mixed Placement');
                recommendations.push('DH - Regional Coverage');
            }
            
            // Budget-based additions
            if (budget >= 100000) {
                recommendations.push('Multi-Platform Premium Campaign');
                recommendations.push('Le Soir + DH Synchronized Launch');
            }
            
            // Sports focus additions
            if (data.creative?.sports_focus?.length > 0) {
                recommendations.push('DH Les Sports+ - Sports Integration');
                recommendations.push('Le Soir Sports Section');
            }
            
            return recommendations.length > 0 ? [...new Set(recommendations)] : ['Le Soir - Standard Placement'];
        }
        
        function generateInternalNotes(data, evaluation) {
            const notes = [];
            const advertiser = data.advertiser.group_or_annonceur || '';
            const product = data.advertiser.brand_or_product || '';
            const budget = parseInt(data.constraints.budget_confirmed_eur_range) || 0;
            
            // Acceptance-specific notes
            if (evaluation.overall_decision === 'accepted') {
                notes.push(`‚úÖ BRIEF ACCEPTED - Budget ‚Ç¨${budget.toLocaleString()} confirmed`);
                notes.push(`üéØ Target: ${data.brief.target_persona}`);
                notes.push(`üìã Next Steps: Contact publisher(s) within 24h for proposal`);
                
                // Client-specific briefing notes
                if (advertiser.toLowerCase().includes('kbc') || advertiser.toLowerCase().includes('cbc')) {
                    notes.push(`üè¶ Banking Client: Focus on trust, local economy, expertise`);
                    notes.push(`üì∞ Recommend Le Soir Business section + L'Echo financial coverage`);
                    notes.push(`üíº Decision makers: Target C-suite and financial directors`);
                }
                
                // Budget-specific recommendations
                if (budget >= 50000) {
                    notes.push(`üí∞ Premium Budget: Propose multi-channel package with added value`);
                } else if (budget >= 20000) {
                    notes.push(`üí∞ Standard Budget: Focus on high-impact single channel solution`);
                }
                
                // Creative guidance
                if (data.brief.key_messages) {
                    notes.push(`üì¢ Key Message: "${data.brief.key_messages}"`);
                }
                
                notes.push(`‚è∞ Proposal Deadline: ${data.constraints.proposal_deadline}`);
                notes.push(`üìû Contact: ${data.contact.responsable_commercial}`);
            }
            
            // Constraints and preferences
            if (data.constraints.do_not?.length > 0) {
                notes.push(`‚ùå Avoid: ${data.constraints.do_not.join(', ')}`);
            }
            
            if (data.constraints.prefer?.length > 0) {
                notes.push(`‚úÖ Prefer: ${data.constraints.prefer.join(', ')}`);
            }
            
            if (data.creative?.sports_focus?.length > 0) {
                notes.push(`‚öΩ Sports focus: ${data.creative.sports_focus.join(', ')}`);
            }
            
            // Issues for rejected briefs
            if (evaluation.issues?.length > 0) {
                notes.push(`‚ö†Ô∏è Issues to resolve: ${evaluation.issues.join(', ')}`);
            }
            
            return notes.length > 0 ? notes.join(' | ') : null;
        }
        
        function showProcessing() {
            elements.uploadSection.style.display = 'none';
            elements.processingSection.style.display = 'flex';
            elements.resultsSection.style.display = 'none';
        }
        
        function updateStatus(message) {
            elements.processingStatus.textContent = message;
            console.log('üìç', message);
        }
        
        function showResults() {
            elements.uploadSection.style.display = 'none';
            elements.processingSection.style.display = 'none';
            elements.resultsSection.style.display = 'block';
            
            updateDecisionBanner();
            populateDataGrid();
        }
        
        function updateDecisionBanner() {
            const { evaluation } = currentData;
            
            // Reset classes
            elements.decisionBanner.className = 'decision-banner';
            elements.decisionIcon.className = 'decision-icon';
            
            if (evaluation.overall_decision === 'accepted') {
                elements.decisionBanner.classList.add('accepted');
                elements.decisionIcon.innerHTML = '<i class="fas fa-check"></i>';
                elements.decisionTitle.textContent = 'ACCEPTED - Brief Approved';
                elements.decisionMessage.textContent = 'All CREATE criteria met. Approved for processing.';
            } else if (evaluation.overall_decision === 'needs_more_info') {
                elements.decisionBanner.classList.add('needs-more-info');
                elements.decisionIcon.classList.add('warning');
                elements.decisionIcon.innerHTML = '<i class="fas fa-exclamation"></i>';
                elements.decisionTitle.textContent = 'NEEDS MORE INFO - Review Required';
                elements.decisionMessage.textContent = 'Core criteria met but additional information needed.';
            } else {
                elements.decisionBanner.classList.add('rejected');
                elements.decisionIcon.classList.add('error');
                elements.decisionIcon.innerHTML = '<i class="fas fa-times"></i>';
                elements.decisionTitle.textContent = 'REJECTED - Brief Declined';
                elements.decisionMessage.textContent = 'CREATE criteria not met. See details below.';
            }
        }
        
        function populateDataGrid() {
            const { briefing, evaluation } = currentData;
            
            const cards = [
                {
                    icon: 'fas fa-file-alt',
                    title: 'Meta Information',
                    fields: [
                        { label: 'Source File', value: briefing.meta.source_file },
                        { label: 'Extraction Date', value: briefing.meta.extraction_ts },
                        { label: 'Overall Decision', value: evaluation.overall_decision.toUpperCase() },
                        { label: 'Score', value: `${evaluation.score}/${evaluation.max_score}` }
                    ]
                },
                {
                    icon: 'fas fa-address-book',
                    title: 'Contact Information',
                    fields: [
                        { label: 'Responsable Commercial', value: briefing.contact.responsable_commercial },
                        { label: 'Agence Media', value: briefing.contact.agence_media }
                    ]
                },
                {
                    icon: 'fas fa-building',
                    title: 'Advertiser',
                    fields: [
                        { label: 'Group/Annonceur', value: briefing.advertiser.group_or_annonceur },
                        { label: 'Brand/Product', value: briefing.advertiser.brand_or_product }
                    ]
                },
                {
                    icon: 'fas fa-clipboard-list',
                    title: 'Brief Details',
                    fields: [
                        { label: 'Type', value: briefing.brief.type },
                        { label: 'Urgency', value: briefing.brief.urgency },
                        { label: 'Typologie Annonceur', value: briefing.brief.typologie_annonceur },
                        { label: 'Target Persona', value: briefing.brief.target_persona },
                        { label: 'Key Messages', value: briefing.brief.key_messages },
                        { label: 'Notes', value: briefing.brief.notes }
                    ]
                },
                {
                    icon: 'fas fa-euro-sign',
                    title: 'Constraints',
                    fields: [
                        { label: 'Min Budget CREATE', value: `‚Ç¨${briefing.constraints.min_budget_create_eur.toLocaleString()}` },
                        { label: 'Budget Confirmed Range', value: formatBudgetRange(briefing.constraints.budget_confirmed_eur_range) },
                        { label: 'Proposal Deadline', value: briefing.constraints.proposal_deadline },
                        { label: 'Lead Time Required', value: `${briefing.constraints.lead_time_business_days_after_valid_brief} business days` },
                        { label: 'Do Not', value: Array.isArray(briefing.constraints.do_not) ? briefing.constraints.do_not.join(', ') : briefing.constraints.do_not },
                        { label: 'Prefer', value: Array.isArray(briefing.constraints.prefer) ? briefing.constraints.prefer.join(', ') : briefing.constraints.prefer }
                    ]
                },
                {
                    icon: 'fas fa-paint-brush',
                    title: 'Creative & Sports',
                    fields: [
                        { label: 'Sports Focus', value: Array.isArray(briefing.creative.sports_focus) ? briefing.creative.sports_focus.join(', ') : briefing.creative.sports_focus },
                        { label: 'Activity Min/Week', value: briefing.creative.audience_activity_min_sessions_per_week ? `${briefing.creative.audience_activity_min_sessions_per_week} sessions` : null }
                    ]
                },
                {
                    icon: 'fas fa-cogs',
                    title: 'Internal Analysis',
                    fields: [
                        { label: 'Acceptance Status', value: evaluation.overall_decision },
                        { label: 'Action Recommend', value: evaluation.action_recommend_publishers ? 'Yes' : 'No' },
                        { label: 'Publisher Recommendations', value: Array.isArray(evaluation.internal_publisher_recommendation) ? evaluation.internal_publisher_recommendation.join(', ') : evaluation.internal_publisher_recommendation },
                        { label: 'Internal Notes', value: evaluation.internal_notes }
                    ]
                }
            ];
            
            elements.dataGrid.innerHTML = cards.map(card => `
                <div class="data-card">
                    <div class="data-header">
                        <i class="${card.icon}"></i>
                        <h3>${card.title}</h3>
                    </div>
                    <div class="data-content">
                        ${card.fields.map(field => `
                            <div class="data-field">
                                <label>${field.label}</label>
                                <span>${field.value || '-'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function formatBudgetRange(range) {
            if (!range) return null;
            
            if (range.includes('-')) {
                const [low, high] = range.split('-');
                return `‚Ç¨${parseInt(low).toLocaleString()}-‚Ç¨${parseInt(high).toLocaleString()}`;
            } else {
                return `‚Ç¨${parseInt(range).toLocaleString()}`;
            }
        }
        
        // Removed exportData function as per user request - system now focuses on extracting FROM PDFs for display
        
        function reset() {
            elements.uploadSection.style.display = 'block';
            elements.manualSection.style.display = 'none';
            elements.processingSection.style.display = 'none';
            elements.resultsSection.style.display = 'none';
            elements.fileInput.value = '';
            elements.uploadArea.classList.remove('dragging');
            currentData = null;
            console.log('üîÑ Reset complete');
        }
        
        function showManualSection() {
            elements.uploadSection.style.display = 'none';
            elements.manualSection.style.display = 'block';
            elements.processingSection.style.display = 'none';
            elements.resultsSection.style.display = 'none';
            console.log('üìù Switched to manual input mode');
        }
        
        function showUploadSection() {
            elements.uploadSection.style.display = 'block';
            elements.manualSection.style.display = 'none';
            elements.processingSection.style.display = 'none';
            elements.resultsSection.style.display = 'none';
            console.log('üìÅ Switched to upload mode');
        }
        
        function detectAdvertiserType(advertiser) {
            const adv = advertiser.toLowerCase();
            if (adv.includes('kbc') || adv.includes('cbc') || adv.includes('banque') || adv.includes('bank')) {
                return 'Services Financiers';
            }
            if (adv.includes('coca') || adv.includes('pepsi') || adv.includes('food') || adv.includes('drink')) {
                return 'FMCG - Alimentaire & Boissons';
            }
            if (adv.includes('telecom') || adv.includes('mobile') || adv.includes('oneplus') || adv.includes('samsung')) {
                return 'T√©l√©communications & Technologie';
            }
            return 'Entreprise Commerciale';
        }
        
        function generateDefaultPersona(advertiser, product) {
            const adv = advertiser.toLowerCase();
            const prod = product.toLowerCase();
            
            // Banking personas
            if (adv.includes('kbc') || adv.includes('cbc')) {
                if (prod.includes('entreprise') || prod.includes('business') || prod.includes('corporate')) {
                    return '25-55 chefs d\'entreprise et d√©cideurs financiers';
                }
                if (prod.includes('priv√©') || prod.includes('private') || prod.includes('wealth')) {
                    return '35-65 clients patrimoniaux et investisseurs';
                }
                return '25-50 professionnels actifs et entrepreneurs';
            }
            
            // FMCG personas
            if (adv.includes('coca') || prod.includes('boisson') || prod.includes('drink')) {
                return '18-45 consommateurs actifs et familles';
            }
            
            // Tech personas  
            if (prod.includes('mobile') || prod.includes('tech') || adv.includes('oneplus')) {
                return '20-40 early adopters et technophiles';
            }
            
            // Default
            return '25-45 consommateurs engag√©s et d√©cideurs';
        }
        
        function generateObjectives(advertiser, product) {
            const adv = advertiser.toLowerCase();
            const prod = product.toLowerCase();
            
            // Banking typically focuses on consideration and conversion
            if (adv.includes('kbc') || adv.includes('cbc') || adv.includes('banque')) {
                return ['consideration', 'activation_conversion'];
            }
            
            // FMCG often includes awareness
            if (adv.includes('coca') || prod.includes('boisson')) {
                return ['awareness', 'consideration'];
            }
            
            // Default comprehensive approach
            return ['awareness', 'consideration', 'activation_conversion'];
        }
        
        function generateDefaultKeyMessages(advertiser, product) {
            const adv = advertiser.toLowerCase();
            const prod = product.toLowerCase();
            
            if (adv.includes('kbc') || adv.includes('cbc')) {
                if (prod.includes('entreprise') || prod.includes('business')) {
                    return 'KBC, votre partenaire financier de confiance pour d√©velopper votre entreprise.';
                }
                return 'Avec KBC/CBC, votre argent travaille pour l\'√©conomie locale.';
            }
            
            if (adv.includes('coca')) {
                return `D√©couvrez ${product}, le go√ªt qui rassemble.`;
            }
            
            return `${product} par ${advertiser} - L'excellence √† votre port√©e.`;
        }
        
        function generateMediaPreferences(advertiser) {
            const adv = advertiser.toLowerCase();
            
            if (adv.includes('kbc') || adv.includes('cbc') || adv.includes('banque')) {
                return ['Le Soir', 'L\'Echo', 'Trends-Tendances', 'DH Les Sports+'];
            }
            
            if (adv.includes('coca') || adv.includes('food') || adv.includes('drink')) {
                return ['Le Soir', 'DH', 'Sudinfo', 'Kotplanet'];
            }
            
            return ['Le Soir', 'DH', 'Sudinfo'];
        }
        
        function generateSportsFocus(advertiser, product) {
            const adv = advertiser.toLowerCase();
            const prod = product.toLowerCase();
            
            if (prod.includes('sport') || prod.includes('fitness') || prod.includes('powerade')) {
                return ['football', 'tennis', 'running', 'fitness'];
            }
            
            if (adv.includes('kbc') || adv.includes('cbc')) {
                return ['football', 'cyclisme']; // KBC sponsors cycling
            }
            
            return null; // No sports focus by default
        }
        
        function generateActivityFrequency(product) {
            const prod = product.toLowerCase();
            
            if (prod.includes('sport') || prod.includes('fitness') || prod.includes('powerade')) {
                return 3; // 3 times per week for sports products
            }
            
            return null; // No activity frequency by default
        }
        
        async function processManualBriefing() {
            console.log('üöÄ Processing manual briefing...');
            
            // Get input values
            const advertiser = document.getElementById('manualAdvertiser').value.trim();
            const product = document.getElementById('manualProduct').value.trim();
            const budget = parseInt(document.getElementById('manualBudget').value);
            const contact = document.getElementById('manualContact').value.trim();
            const persona = document.getElementById('manualPersona').value.trim();
            const deadline = document.getElementById('manualDeadline').value;
            const messages = document.getElementById('manualMessages').value.trim();
            const notes = document.getElementById('manualNotes').value.trim();
            
            // Validate required fields
            if (!advertiser || !product || !budget || !contact) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }
            
            if (budget < 1000) {
                alert('Budget must be at least ‚Ç¨1,000');
                return;
            }
            
            // Show processing
            showProcessing();
            updateStatus('Creating manual briefing...');
            await delay(500);
            
            // Create briefing data structure
            const today = new Date().toISOString().split('T')[0];
            
            // If no deadline provided, set a reasonable default (30 days from now)
            let finalDeadline = deadline;
            if (!deadline) {
                const futureDate = new Date();
                futureDate.setDate(futureDate.getDate() + 30);
                finalDeadline = futureDate.toISOString().split('T')[0];
                console.log('‚ÑπÔ∏è No deadline provided, using default:', finalDeadline);
            }
            
            const briefingData = {
                meta: {
                    source_file: 'Manual Input',
                    extraction_ts: today
                },
                contact: {
                    responsable_commercial: contact,
                    agence_media: null
                },
                advertiser: {
                    group_or_annonceur: advertiser,
                    brand_or_product: product
                },
                brief: {
                    type: 'Manual',
                    urgency: 'moyen',  // Default to moderate urgency
                    typologie_annonceur: detectAdvertiserType(advertiser),
                    presentation_languages: ['Fran√ßais'], // Default for Belgian market
                    attachments_present: false,
                    target_persona: persona || generateDefaultPersona(advertiser, product),
                    objectives: generateObjectives(advertiser, product),
                    start_momentum_reason: 'Campagne de sensibilisation et conversion',
                    end_date: finalDeadline,
                    key_messages: messages || generateDefaultKeyMessages(advertiser, product),
                    media_specific_preferences: generateMediaPreferences(advertiser),
                    history_with_rossel: 'Client r√©gulier avec campagnes pr√©c√©dentes',
                    other_campaigns_with_rossel: null,
                    notes: notes || `Campagne ${product} pour ${advertiser}. Focus sur l'engagement digital et la conversion.`
                },
                constraints: {
                    min_budget_create_eur: 10000,
                    budget_confirmed_eur_range: budget.toString(),
                    proposal_deadline: finalDeadline,
                    lead_time_business_days_after_valid_brief: 10,
                    do_not: null,
                    prefer: null
                },
                creative: {
                    sports_focus: generateSportsFocus(advertiser, product),
                    audience_activity_min_sessions_per_week: generateActivityFrequency(product)
                },
                internal: {
                    briefing_acceptance_status: 'needs_more_info',
                    acceptance_reason: null,
                    action_recommend_publishers: false,
                    internal_publisher_recommendation: null,
                    internal_notes: null
                },
                supplemental: {
                    other_fields: null,
                    source_field_map: null
                }
            };
            
            updateStatus('Evaluating CREATE criteria...');
            await delay(800);
            
            // Evaluate the briefing
            const evaluation = evaluateCreateCriteriaV4(briefingData);
            console.log('üéØ Manual briefing evaluation:', evaluation);
            
            updateStatus('Finalizing results...');
            await delay(600);
            
            // Store and show results
            currentData = { briefing: briefingData, evaluation, originalText: `Manual briefing for ${advertiser} - ${product}` };
            showResults();
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Make functions globally available
        window.reset = reset;
        window.showManualSection = showManualSection;
        window.showUploadSection = showUploadSection;
        window.processManualBriefing = processManualBriefing;
        
        console.log('‚úÖ Brand Studio CREATE v4 Ready! (CLAUDE.md v4 Compliant)');
    </script>
</body>
</html>